syncPolicy:
  automated:
    selfHeal: false
    allowEmpty: true
    prune: false
  retry:
    limit: -1 # number of failed sync attempt retries; unlimited number of attempts if less than 0
    backoff:
      duration: 5s # the amount to back off. Default unit is seconds, but could also be a duration (e.g. "2m", "1h")
      factor: 2 # a factor to multiply the base duration after each failed retry
      maxDuration: 10m # the maximum amount of time allowed for the backoff strategy
  syncOptions:
    - CreateNamespace=true
    - ServerSideApply=true # Big CRDs.
syncPolicyAppSet:
  preserveResourcesOnDeletion: false # to be able to cleanup
useSelectors: true
repoURLGit: '{{.metadata.annotations.addons_repo_url}}'
repoURLGitRevision: '{{.metadata.annotations.addons_repo_revision}}'
repoURLGitBasePath: '{{.metadata.annotations.addons_repo_basepath}}'
valueFiles:
  - default/addons
  - environments/{{.metadata.labels.environment}}/addons
  - clusters/{{.nameNormalized}}/addons
useValuesFilePrefix: true
valuesFilePrefix: 'tenants/{{.metadata.labels.tenant}}/'

########################################
# define Addons
argocd:
  enabled: false
  chartName: argo-cd
  namespace: argocd
  releaseName: argocd
  defaultVersion: '7.9.1'
  chartRepository: 'https://argoproj.github.io/argo-helm'
  annotationsAppSet:
    argocd.argoproj.io/sync-wave: '0' # Default sync-wave for ArgoCD
  selector:
    matchExpressions:
      - key: enable_argocd
        operator: In
        values: ['true']
  valuesObject:
    global:
      domain: '{{.metadata.annotations.ingress_domain_name}}'
      resourcePrefix: '{{.metadata.annotations.resource_prefix}}'
    configs:
      cm:
        url: https://{{.metadata.annotations.ingress_domain_name}}/argocd
        oidc.config: |
          name: Keycloak
          issuer: https://{{.metadata.annotations.ingress_domain_name}}/keycloak/realms/platform
          clientID: argocd
          clientSecret: $oidc.keycloak.clientSecret
          requestedScopes: ["openid", "profile", "email", "groups"]
ack-iam:
  enableACK: false
    argocd.argoproj.io/sync-wave: '-1' # Needs to be after KRO RGD
  namespace: ack-system
  defaultVersion: '1.3.16'
  chartNamespace: aws-controllers-k8s
  chartName: iam-chart
  chartRepository: public.ecr.aws
      - key: enable_ack_iam
  ignoreDifferences:
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      jsonPointers:
        - /spec/versions/0/schema/openAPIV3Schema/properties/spec/properties/generateName
        - /spec/versions/*/schema/openAPIV3Schema/properties/*/generateName
        - /spec/versions/*/schema/openAPIV3Schema/properties/*/properties/*/generateName
        - /spec/versions/0/schema/openAPIV3Schema/properties/metadata/properties/generateName
        - /spec/versions/0/schema/openAPIV3Schema/properties/metadata/description
        - /spec/versions/0/schema/openAPIV3Schema/properties/spec/description
    aws:
      region: '{{.metadata.annotations.aws_region}}'
    serviceAccount:
      name: '{{default "ack-iam-controller" (index .metadata.annotations "ack_iam_service_account")}}'
        - /metadata/annotations/controller-gen.kubebuilder.io~1version
        - /spec/versions/*/schema/openAPIV3Schema/description
        - /spec/versions/*/schema/openAPIV3Schema/properties/*/description
        - /spec/versions/*/schema/openAPIV3Schema/properties/*/properties/*/description
      managedFieldsManagers:
        - kube-controller-manager
ack-eks:
  chartName: eks-chart
  defaultVersion: '1.6.0'
      - key: enable_ack_eks
      name: '{{default "ack-eks-controller" (index .metadata.annotations "ack_eks_service_account")}}'
ack-s3:
  enabled: true
  chartName: s3-chart
  defaultVersion: '1.0.14'
  releaseName: s3-chart
      - key: enable_ack_s3
      name: '{{default "ack-s3-controller" (index .metadata.annotations "ack_s3_service_account")}}'
ack-dynamodb:
  chartName: dynamodb-chart
  defaultVersion: '1.2.19'
  releaseName: dynamodb-chart
      - key: enable_ack_dynamodb
      name: '{{default "ack-dynamodb-controller" (index .metadata.annotations "ack_dynamodb_service_account")}}'
ack-ec2:
  chartName: ec2-chart
  defaultVersion: '1.3.4'
      - key: enable_ack_ec2
      name: '{{default "ack-ec2-controller" (index .metadata.annotations "ack_ec2_service_account")}}'
external-secrets:
  namespace: external-secrets
  chartName: external-secrets
  defaultVersion: '0.10.3'
  chartRepository: 'https://charts.external-secrets.io'
      - key: enable_external_secrets
      name: 'external-secrets-sa'
metrics-server:
  namespace: kube-system
  chartName: metrics-server
  defaultVersion: '3.12.1'
  chartRepository: 'https://kubernetes-sigs.github.io/metrics-server'
    argocd.argoproj.io/sync-wave: '0' # Default sync-wave for metrics-server
      - key: enable_metrics_server
kro:
  namespace: kro-system
    argocd.argoproj.io/sync-wave: '-3' # Needs to be before resources that needs PodIdentity
  defaultVersion: '0.2.1'
  chartName: kro
  chartNamespace: kro-run/kro
  chartRepository: ghcr.io
      - key: enable_kro
ack-efs:
  enable: false
  enableACK: true
    argocd.argoproj.io/sync-wave: '0' # Needs to be after KRO RGD
  chartName: efs-chart
  defaultVersion: '1.0.6'
      - key: enable_ack_efs
      - key: fleet_member
        operator: NotIn
        values: ['control-plane']
      name: 'ack-efs-controller'
aws_efs_csi_driver:
  releaseName: aws-efs-csi-driver
    argocd.argoproj.io/sync-wave: '4' # Needs to be after eck-efs
  namespace: 'kube-sytem'
  chartName: aws-efs-csi-driver
  chartRepository: https://kubernetes-sigs.github.io/aws-efs-csi-driver
  defaultVersion: '3.0.7'
      - key: enable_aws_efs_csi_driver
    controller:
      serviceAccount:
        name: '{{default "efs-csi-controller-sa" (index  .metadata.annotations "aws_efs_csi_driver_controller_service_account")}}'
        annotations:
          eks.amazonaws.com/role-arn: '{{default "" (index .metadata.annotations "aws_efs_csi_driver_iam_role_arn")}}'
    node:
        name: '{{default "efs-csi-node-sa" (index .metadata.annotations "aws_efs_csi_driver_node_service_account")}}'
aws_for_fluentbit:
  releaseName: aws-for-fluentbit
  namespace: '{{ default "kube-system" (index .metadata.annotations "aws_for_fluentbit_namespace") }}'
    argocd.argoproj.io/sync-wave: '3' # Needs to be after KRO RGD
  chartName: aws-for-fluent-bit
  chartRepository: https://aws.github.io/eks-charts
  defaultVersion: '0.1.34'
      - key: enable_aws_for_fluentbit
  values:
    cloudWatchLogs:
      enabled: true
      logGroupName: '{{.metadata.annotations.aws_for_fluentbit_log_group_name}}'
      logGroupTemplate: "{{.metadata.annotations.aws_for_fluentbit_log_group_name}}/workload/$kubernetes['namespace_name']"
      logStreamTemplate: "$kubernetes['pod_name'].$kubernetes['container_name']"
      logRetentionDays: 90
      name: '{{ default "aws-for-fluentbit" (index .metadata.annotations "aws_for_fluentbit_service_account") }}'
cert_manager:
  releaseName: cert-manager
  namespace: '{{ default "cert-manager" (index .metadata.annotations "cert-manager_namespace") }}'
  chartName: cert-manager
  chartRepository: https://charts.jetstack.io
  defaultVersion: 'v1.15.2'
    argocd.argoproj.io/sync-wave: '2'
      - key: enable_cert_manager
  # values:
  #   installCRDs: true
  #   serviceAccount:
  #     name: '{{ default "cert-manager" (index .metadata.annotations "cert_manager_service_account") }}'
external_dns:
  releaseName: external-dns
  namespace: '{{ default "kube-system" (index .metadata.annotations "external_dns_namespace") }}'
  chartName: external-dns
  chartRepository: https://kubernetes-sigs.github.io/external-dns
  defaultVersion: '1.14.5'
      - key: enable_external_dns
    provider: aws
      name: '{{default "external-dns" (index .metadata.annotations "external_dns_service_account")}}'
    domainFilters: ['{{.metadata.annotations.external_dns_domain_filters}}']
    txtOwnerId: '{{.metadata.annotations.aws_cluster_name}}'
    policy: '{{ default "upsert-only" (index .metadata.annotations "external_dns_policy")}}'
opentelemetry_operator:
  releaseName: opentelemetry-operator
  namespace: 'opentelemetry-operator-system'
  chartName: opentelemetry-operator
  chartRepository: https://open-telemetry.github.io/opentelemetry-helm-charts
  defaultVersion: '0.71.1'
    manager:
      collectorImage:
        repository: 'otel/opentelemetry-collector-k8s'
      - key: enable_opentelemetry_operator
kyverno:
  releaseName: kyverno
  namespace: '{{ default "kyverno" (index .metadata.annotations "kyverno_namespace")}}'
  chartName: kyverno
  chartRepository: https://kyverno.github.io/kyverno
  defaultVersion: '3.3.4'
      - key: enable_kyverno
  resources:
    path: '{{.metadata.annotations.addons_repo_basepath}}charts/resources/kyverno'
    helm:
      valuesObject:
        environment: '{{.metadata.labels.environment}}'
kyverno_policy_reporter:
  releaseName: kyverno-policy-reporter
    argocd.argoproj.io/sync-wave: '4' # Needs to be after KRO RGD
  chartName: policy-reporter
  chartRepository: https://kyverno.github.io/policy-reporter
  defaultVersion: '3.0.0'
      - key: enable_kyverno_policy_reporter
      name: policy-reporter
    logging:
      logLevel: 0
    plugin:
      kyverno:
        enabled: true
    ui:
      banner: '{{.metadata.annotations.aws_cluster_name}}'
    target:
      securityHub:
        accountId: '{{.metadata.annotations.aws_account_id}}'
        region: '{{.metadata.annotations.aws_region}}'
        productName: '{{.metadata.annotations.aws_cluster_name}}'
        skipExistingOnStartup: false
        delayInSeconds: 10
        customFields:
          cluster: '{{.metadata.annotations.aws_cluster_name}}'
          region: '{{.metadata.annotations.aws_region}}'
          account: '{{.metadata.annotations.aws_account_id}}'
          eks_console_url: 'https://{{.metadata.annotations.aws_region}}.console.aws.amazon.com/eks/home?region={{.metadata.annotations.aws_region}}#/clusters/{{.metadata.annotations.aws_cluster_name}}?selectedTab=cluster-resources-tab&selectedResourceId=namespaces'
        minimumPriority: 'warning'
        synchronize: true
kyverno_policies:
  releaseName: kyverno-policies
  chartName: kyverno-policies
  defaultVersion: '3.2.5'
      - key: enable_kyverno_policies
    podSecurityStandard: restricted
    validationFailureAction: Audit
    skipBackgroundRequests: false
cni_metrics_helper:
  releaseName: cni-metrics-helper
  namespace: '{{ default "kube-system" (index .metadata.annotations "cni_metrics_helper_namespace")}}'
  chartName: cni-metrics-helper
  defaultVersion: '1.19.2'
    env:
      AWS_CLUSTER_ID: '{{.metadata.annotations.aws_cluster_name}}'
      - key: enable_cni_metrics_helper
kube_state_metrics:
  releaseName: kube-state-metrics
  namespace: '{{ default "kube-prometheus-stack" (index .metadata.annotations "kube_state_metrics_namespace")}}'
  chartName: kube-state-metrics
  chartRepository: https://prometheus-community.github.io/helm-charts
  defaultVersion: '5.25.1'
      - key: enable_kube_state_metrics
prometheus_node_exporter:
  releaseName: prometheus-node-exporter
  namespace: '{{ default "kube-prometheus-stack" (index .metadata.annotations "prometheus_node_exporter_namespace")}}'
  chartName: prometheus-node-exporter
  defaultVersion: '4.39.0'
      - key: enable_prometheus_node_exporter
cw_prometheus:
  namespace: '{{ default "amazon-cloudwatch" (index .metadata.annotations "cw_prometheus_namespace")}}'
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/cw-prometheus'
  chartRepository: '{{.metadata.annotations.addons_repo_url}}'
  targetRevision: '{{.metadata.annotations.addons_repo_revision}}'
      - key: enable_cw_prometheus
kro-eks-rgs:
  type: manifest
  namespace: kro
    argocd.argoproj.io/sync-wave: '-2' # Needs to be before resources that needs PodIdentity
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/kro/resource-groups/eks'
      - key: enable_kro_eks_rgs
multi-acct:
    argocd.argoproj.io/sync-wave: '-5' # Needs to be before KRO RGD
  defaultVersion: '0.1.0'
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/multi-acct'
      - key: enable_mutli_acct
ingress-class-alb:
    argocd.argoproj.io/sync-wave: '0'
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/ingress-class-alb'
      - key: enable_ingress_class_alb
argo-rollouts:
    argocd.argoproj.io/sync-wave: '3'
  namespace: argo-rollouts
  chartName: argo-rollouts
  chartRepository: https://argoproj.github.io/argo-helm
  defaultVersion: '2.39.5'
      - key: enable_argo_rollouts
ingress-nginx:
    argocd.argoproj.io/sync-wave: '1'
  namespace: ingress-nginx
  chartName: ingress-nginx
  chartRepository: https://kubernetes.github.io/ingress-nginx
  defaultVersion: '4.12.2'
      - key: enable_ingress_nginx
      service:
          service.beta.kubernetes.io/aws-load-balancer-name: '{{.metadata.annotations.ingress_name}}'
          service.beta.kubernetes.io/aws-load-balancer-security-groups: '{{.metadata.annotations.ingress_security_groups}}'
gitlab:
    argocd.argoproj.io/sync-wave: '2' # Needs to be after External and Ingress Nginx
  namespace: gitlab
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/gitlab'
      - key: enable_gitlab
    domain_name: '{{.metadata.annotations.gitlab_domain_name}}'
    initial_root_password: '{{.metadata.annotations.ide_password}}'
    security_groups: '{{.metadata.annotations.gitlab_security_groups}}'
    git_username: '{{.metadata.annotations.git_username}}'
    working_repo: '{{.metadata.annotations.working_repo}}'
keycloak:
    argocd.argoproj.io/sync-wave: '3' # Needs to be after External Secrets, Ingress Nginx and Gitlab
  namespace: keycloak
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/keycloak'
      - key: enable_keycloak
    ingress_domain_name: '{{.metadata.annotations.ingress_domain_name}}'
    - group: external-secrets.io
      kind: ExternalSecret
        - /status
        - /metadata/generation
        - /metadata/managedFields
    - group: ''
      kind: Secret
    - group: apps
      kind: StatefulSet
        # Ignore default values added by Kubernetes to volumeClaimTemplates
argo-workflows:
    argocd.argoproj.io/sync-wave: '6' # Needs to be after Keycloak
  namespace: argo
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/argo-workflows'
      - key: enable_argo_workflows
        - /metadata/resourceVersion
      name: keycloak-oidc
kargo:
  namespace: kargo
  chartName: kargo
  chartRepository: ghcr.io/akuity/kargo-charts
  defaultVersion: '1.5.3'
      - key: enable_kargo
    api:
      host: '{{.metadata.annotations.ingress_domain_name}}'
      argocd:
        urls:
          - https://{{.metadata.annotations.ingress_domain_name}}/argocd
      oidc:
        issuerURL: https://{{.metadata.annotations.ingress_domain_name}}/keycloak/realms/platform
      adminAccount:
        # $IDE_PASSWORD
        passwordHash: '{{.metadata.annotations.ide_password_hash}}'
        tokenSigningKey: '{{.metadata.annotations.ide_password_key}}'
kubevela:
  namespace: vela-system
  chartName: vela-core
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/kubevela'
      - key: enable_kubevela
    systemDefinitionNamespace: vela-system
    - group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
        - /webhooks/0/clientConfig/caBundle
        - /webhooks/1/clientConfig/caBundle
        - /webhooks/2/clientConfig/caBundle
        - /webhooks/3/clientConfig/caBundle
        - /webhooks/4/clientConfig/caBundle
        - /webhooks/0/failurePolicy
        - /webhooks/1/failurePolicy
        - /webhooks/2/failurePolicy
        - /webhooks/3/failurePolicy
        - /webhooks/4/failurePolicy
        - /webhooks/0/timeoutSeconds
        - /webhooks/1/timeoutSeconds
        - /webhooks/2/timeoutSeconds
        - /webhooks/3/timeoutSeconds
        - /webhooks/4/timeoutSeconds
      kind: ValidatingWebhookConfiguration
    - group: apiregistration.k8s.io
      kind: APIService
    - group: '*'
      kind: '*'
        - vela-core
        - cert-manager
        - webhook-cert-manager
        - apiserver
crossplane:
    argocd.argoproj.io/sync-wave: '5' # Needs to be after external-secrets and before infrastructure provisioning
  namespace: crossplane-system
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/crossplane'
      - key: enable_crossplane
      accountId: '{{.metadata.annotations.aws_account_id}}'
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - Replace=true # For CRD updates
grafana:
    argocd.argoproj.io/sync-wave: '4' # Needs to be after external-secrets and ingress-nginx
  namespace: grafana
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/grafana'
      - key: enable_grafana
        # Ignore default values added by ESO to remoteRef
    - group: networking.k8s.io
      kind: Ingress
      kind: Deployment
  healthCheck:
    enabled: true
flux:
    argocd.argoproj.io/sync-wave: '4' # Needs to be early for alternative GitOps solution
  namespace: flux-system
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/flux'
      - key: enable_flux
    clusterName: '{{.metadata.annotations.cluster_name}}'
    gitRepository:
      url: '{{.metadata.annotations.addons_repo_url}}'
      branch: '{{.metadata.annotations.addons_repo_revision}}'
    workloadsRepository:
      url: '{{.metadata.annotations.workload_repo_url}}'
      branch: '{{.metadata.annotations.workload_repo_revision}}'
    platformAddons:
      path: '{{.metadata.annotations.addons_repo_basepath}}addons'
    workloads:
      path: '{{.metadata.annotations.workload_repo_basepath}}apps'
    secrets:
      gitCredentials:
        secretName: '{{.metadata.annotations.resource_prefix}}-gitlab-pat'
    - group: rbac.authorization.k8s.io
      kind: ClusterRole
        - /rules
        - /metadata/labels
        - /metadata/annotations
      kind: ClusterRoleBinding
        - /subjects
        - /roleRef
        - /spec/data/0/remoteRef/conversionStrategy
        - /spec/data/0/remoteRef/decodingStrategy
        - /spec/data/0/remoteRef/metadataPolicy
        - /spec/data/1/remoteRef/conversionStrategy
        - /spec/data/1/remoteRef/decodingStrategy
        - /spec/data/1/remoteRef/metadataPolicy
        - /spec/target/template/engineVersion
        - /spec/target/template/mergePolicy
    - group: source.toolkit.fluxcd.io
      kind: GitRepository
backstage:
    argocd.argoproj.io/sync-wave: '7' # Needs to be after all addons
  namespace: backstage
  path: '{{.metadata.annotations.addons_repo_basepath}}charts/backstage'
      - key: enable_backstage
    gitlab_domain_name: '{{.metadata.annotations.gitlab_domain_name}}'
    backstage_image: '{{.metadata.annotations.backstage_image}}'
