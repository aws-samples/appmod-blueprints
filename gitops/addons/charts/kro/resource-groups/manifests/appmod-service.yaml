apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: appmodservice.kro.run
  annotations:
    argocd.argoproj.io/sync-wave: '0'
    argocd.argoproj.io/sync-options: Replace=false
spec:
  schema:
    apiVersion: v1alpha1
    kind: AppmodService
    types:
      EnvVar:
        name: string
        value: string
    spec:
      image: string
      image_name: string
      replicas: integer | default=3
      port: integer | default=80
      targetPort: integer | default=8080
      serviceAccount: string | default="default"
      clusterName: string
      accountId: string | default=""
      envName: string | default="PRODUCTION"
      apiBaseUrl: string | default=""
      env: "[]EnvVar | default=[]"
      components:
        dynamodb:
          enabled: boolean | default=false
          tableName: string | default=""
          partitionKey: string | default="partition_key"
          partitionKeyType: string | default="S"
          sortKey: string | default="sort_key"
          sortKeyType: string | default="S"
      ingress:
        host: string | default="*.elb.us-west-2.amazonaws.com"
        enabled: boolean | default=false
        path: string | default="/"
        rewrite: boolean | default=true
      functionalGate:
        enabled: boolean | default=false
        image: string | default="httpd:alpine"
        extraArgs: string | default=""
        pause: string | default="5s"
      performanceGate:
        enabled: boolean | default=false
        image: string | default="httpd:alpine"
        extraArgs: string | default="160"
        pause: string | default="5s"
      metrics:
        enabled: boolean | default=false
  resources:
    - id: iamroleselector
      includeWhen:
        - ${schema.spec.components.dynamodb.enabled == true}
      template:
        apiVersion: services.k8s.aws/v1alpha1
        kind: IAMRoleSelector
        metadata:
          name: ${schema.metadata.namespace}-iam
          annotations:
            services.k8s.aws/adoption-policy: adopt-or-create
        spec:
          arn: arn:aws:iam::${schema.spec.accountId}:role/peeks-cluster-mgmt-iam
          namespaceSelector:
            names:
              - ${schema.metadata.namespace}
          resourceTypeSelector:
            - group: iam.services.k8s.aws
              kind: ""
              version: ""
    - id: eksroleselector
      includeWhen:
        - ${schema.spec.components.dynamodb.enabled == true}
      template:
        apiVersion: services.k8s.aws/v1alpha1
        kind: IAMRoleSelector
        metadata:
          name: ${schema.metadata.namespace}-eks
          annotations:
            services.k8s.aws/adoption-policy: adopt-or-create
        spec:
          arn: arn:aws:iam::${schema.spec.accountId}:role/peeks-cluster-mgmt-eks
          namespaceSelector:
            names:
              - ${schema.metadata.namespace}
          resourceTypeSelector:
            - group: eks.services.k8s.aws
              kind: ""
              version: ""
    - id: dynamodbroleselector
      includeWhen:
        - ${schema.spec.components.dynamodb.enabled == true}
      template:
        apiVersion: services.k8s.aws/v1alpha1
        kind: IAMRoleSelector
        metadata:
          name: ${schema.metadata.namespace}-dynamodb
          annotations:
            services.k8s.aws/adoption-policy: adopt-or-create
        spec:
          arn: arn:aws:iam::${schema.spec.accountId}:role/peeks-cluster-mgmt-dynamodb
          namespaceSelector:
            names:
              - ${schema.metadata.namespace}
          resourceTypeSelector:
            - group: dynamodb.services.k8s.aws
              kind: ""
              version: ""
    - id: dynamodbtable
      includeWhen:
        - ${schema.spec.components.dynamodb.enabled == true}
      readyWhen:
        - ${dynamodbtable.status.conditions.exists(x, x.type == 'ACK.ResourceSynced' && x.status == "True")}
      template:
        apiVersion: dynamodb.services.k8s.aws/v1alpha1
        kind: Table
        metadata:
          name: ${schema.spec.components.dynamodb.tableName}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
        spec:
          tableName: ${schema.spec.components.dynamodb.tableName}
          billingMode: PAY_PER_REQUEST
          attributeDefinitions:
            - attributeName: ${schema.spec.components.dynamodb.partitionKey}
              attributeType: ${schema.spec.components.dynamodb.partitionKeyType}
            - attributeName: ${schema.spec.components.dynamodb.sortKey}
              attributeType: ${schema.spec.components.dynamodb.sortKeyType}
          keySchema:
            - attributeName: ${schema.spec.components.dynamodb.partitionKey}
              keyType: HASH
            - attributeName: ${schema.spec.components.dynamodb.sortKey}
              keyType: RANGE
    - id: iamrole
      includeWhen:
        - ${schema.spec.components.dynamodb.enabled == true}
      readyWhen:
        - ${iamrole.status.conditions.exists(x, x.type == 'ACK.ResourceSynced' && x.status == "True")}
      template:
        apiVersion: iam.services.k8s.aws/v1alpha1
        kind: Role
        metadata:
          name: ${schema.metadata.name}-role
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
        spec:
          name: ${schema.metadata.name}-role
          assumeRolePolicyDocument: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": "pods.eks.amazonaws.com"
                  },
                  "Action": [
                    "sts:AssumeRole",
                    "sts:TagSession"
                  ]
                }
              ]
            }
          policies:
            - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
    - id: podidentity
      includeWhen:
        - ${schema.spec.components.dynamodb.enabled == true}
      template:
        apiVersion: eks.services.k8s.aws/v1alpha1
        kind: PodIdentityAssociation
        metadata:
          name: ${schema.metadata.name}-podidentity
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
        spec:
          clusterName: ${schema.spec.clusterName}
          namespace: ${schema.metadata.namespace}
          roleARN: ${iamrole.status.ackResourceMetadata.arn}
          serviceAccount: ${schema.spec.serviceAccount}
    - id: serviceaccount
      template:
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: ${schema.spec.serviceAccount}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
    - id: rollout
      template:
        apiVersion: argoproj.io/v1alpha1
        kind: Rollout
        metadata:
          name: ${schema.metadata.name}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
        spec:
          replicas: ${schema.spec.replicas}
          revisionHistoryLimit: 2
          selector:
            matchLabels:
              app: ${schema.metadata.name}
          strategy:
            canary:
              canaryService: ${previewservice.metadata.name}
              stableService: ${service.metadata.name}
              steps:
                - setWeight: 20
                - pause:
                    duration: 5s
                - setWeight: 40
                - pause:
                    duration: 5s
                - setWeight: 60
                - pause:
                    duration: 5s
                - setWeight: 80
          template:
            metadata:
              labels:
                app: ${schema.metadata.name}
              annotations:
                replicas: "${string(schema.spec.replicas)}"
            spec:
              serviceAccountName: ${schema.spec.serviceAccount}
              containers:
                - name: ${schema.spec.image_name}
                  image: ${schema.spec.image}
                  imagePullPolicy: Always
                  ports:
                    - containerPort: ${schema.spec.targetPort}
                  env:
                    - name: APP_ENV
                      value: ${schema.spec.envName}
                    - name: API_BASE_URL
                      value: ${schema.spec.apiBaseUrl}
                    - name: TABLE_NAME
                      value: ${schema.spec.components.dynamodb.tableName}

    - id: service
      template:
        apiVersion: v1
        kind: Service
        metadata:
          name: ${schema.metadata.name}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
        spec:
          selector:
            app: ${schema.metadata.name}
          ports:
            - port: ${schema.spec.port}
              targetPort: ${schema.spec.targetPort}

    - id: previewservice
      template:
        apiVersion: v1
        kind: Service
        metadata:
          name: ${schema.metadata.name}-preview
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
        spec:
          selector:
            app: ${schema.metadata.name}
          ports:
            - port: ${schema.spec.port}
              targetPort: ${schema.spec.targetPort}

    - id: ingress
      includeWhen:
        - ${schema.spec.ingress.enabled}
        - ${schema.spec.ingress.rewrite == true}
      template:
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: ${schema.metadata.name}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
            nginx.ingress.kubernetes.io/rewrite-target: /$2
            nginx.ingress.kubernetes.io/use-regex: "true"
        spec:
          ingressClassName: nginx
          rules:
            - host: ${schema.spec.ingress.host}
              http:
                paths:
                  - path: "${schema.spec.ingress.path + \"(/|$)(.*)\"}"
                    pathType: ImplementationSpecific
                    backend:
                      service:
                        name: ${service.metadata.name}
                        port:
                          number: ${schema.spec.port}

    - id: ingressNoRewrite
      includeWhen:
        - ${schema.spec.ingress.enabled}
        - ${schema.spec.ingress.rewrite == false}
      template:
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: ${schema.metadata.name}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
            nginx.ingress.kubernetes.io/use-regex: "true"
        spec:
          ingressClassName: nginx
          rules:
            - host: ${schema.spec.ingress.host}
              http:
                paths:
                  - path: "${schema.spec.ingress.path + \"(/|$)(.*)\"}"
                    pathType: ImplementationSpecific
                    backend:
                      service:
                        name: ${service.metadata.name}
                        port:
                          number: ${schema.spec.port}

    - id: ampsecrets
      template:
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: amp-workspace-secrets-${schema.metadata.name}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
        spec:
          secretStoreRef:
            name: aws-secrets-manager
            kind: ClusterSecretStore
          target:
            name: amp-workspace-${schema.metadata.name}
            template:
              type: Opaque
          data:
            - secretKey: amp-workspace-url
              remoteRef:
                key: peeks/platform/amp
                property: amp-workspace
            - secretKey: amp-workspace-region
              remoteRef:
                key: peeks/platform/amp
                property: amp-region

    - id: functionalanalysis
      includeWhen:
        - ${schema.spec.functionalGate.enabled}
      template:
        apiVersion: argoproj.io/v1alpha1
        kind: AnalysisTemplate
        metadata:
          name: functional-gate-${schema.metadata.name}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
        spec:
          args:
            - name: service-name
          metrics:
            - name: ${schema.metadata.name}-metrics
              provider:
                job:
                  spec:
                    template:
                      spec:
                        containers:
                          - name: test
                            image: ${schema.spec.functionalGate.image}
                            command: ["sh"]
                            args:
                              - "-c"
                              - "wget -qO- http://{{args.service-name}}:${string(schema.spec.port)}${schema.spec.ingress.path}/ | grep -q '${schema.spec.functionalGate.extraArgs}'"
                        restartPolicy: Never
                    backoffLimit: 0

    - id: performanceanalysis
      includeWhen:
        - ${schema.spec.performanceGate.enabled}
      template:
        apiVersion: argoproj.io/v1alpha1
        kind: AnalysisTemplate
        metadata:
          name: performance-gate-${schema.metadata.name}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
        spec:
          args:
            - name: service-name
          metrics:
            - name: ${schema.metadata.name}-metrics
              provider:
                job:
                  spec:
                    template:
                      spec:
                        containers:
                          - name: test
                            image: ${schema.spec.performanceGate.image}
                            command: ["sh"]
                            args:
                              - "-c"
                              - "RESULT=$(ab -n 1000 -c 10 http://{{args.service-name}}:${string(schema.spec.port)}${schema.spec.ingress.path}/ 2>/dev/null | grep -o 'Time per request:[^[]*' | head -1 | awk '{print int($4)}'); [ $RESULT -lt ${schema.spec.performanceGate.extraArgs} ] && exit 0 || exit 1"
                        restartPolicy: Never
                    backoffLimit: 0

    - id: metricsanalysis
      includeWhen:
        - ${schema.spec.metrics.enabled}
      template:
        apiVersion: argoproj.io/v1alpha1
        kind: AnalysisTemplate
        metadata:
          name: metrics-${schema.metadata.name}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
        spec:
          args:
            - name: service-name
            - name: amp-workspace-url
              valueFrom:
                secretKeyRef:
                  name: ${ampsecrets.spec.target.name}
                  key: amp-workspace-url
            - name: amp-workspace-region
              valueFrom:
                secretKeyRef:
                  name: ${ampsecrets.spec.target.name}
                  key: amp-workspace-region
          metrics:
            - name: metric0-${schema.metadata.name}
              interval: 1s
              count: 1
              successCondition: "result[0] > 0"
              provider:
                prometheus:
                  address: "{{args.amp-workspace-url}}"
                  query: "up{k8s_container_name=\"${schema.spec.image_name}\", k8s_namespace_name=\"${schema.metadata.namespace}\"}"
                  authentication:
                    sigv4:
                      region: "{{args.amp-workspace-region}}"

    - id: benchmarkconfig
      includeWhen:
        - ${schema.spec.performanceGate.enabled}
      template:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: benchmark-config-${schema.metadata.name}
          ownerReferences:
            - apiVersion: kro.run/v1alpha1
              kind: ${schema.kind}
              name: ${schema.metadata.name}
              uid: ${schema.metadata.uid}
              blockOwnerDeletion: true
              controller: false
          annotations:
            argocd.argoproj.io/tracking-id: ${schema.metadata.?annotations["argocd.argoproj.io/tracking-id"].orValue("")}
        data:
          benchmark.yaml: |
            config:
              target: "http://127.0.0.1:80"
              phases:
                - duration: 5
                  arrivalRate: 1
                  rampTo: 10
                  name: Warm up
            scenarios:
              - name: "Navigate Menus"
                flow:
                  - get:
                      url: "/collection/FRONT_PAGE"
