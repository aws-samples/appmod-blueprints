---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: devlake-mysql-setup-sa
  namespace: {{ .Values.namespace | default "devlake" }}
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: devlake-mysql-setup-access-binding
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
subjects:
- kind: ServiceAccount
  name: devlake-mysql-setup-sa
  namespace: {{ .Values.namespace | default "devlake" }}
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: mysql-setup-workflow
  namespace: {{ .Values.namespace | default "devlake" }}
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  serviceAccountName: devlake-mysql-setup-sa
  entrypoint: mysql-setup
  templates:
  - name: mysql-setup
    dag:
      tasks:
      - name: find-secret
        template: find-secret
        arguments:
          parameters:
          - name: connection-secret-namespace
            value: "crossplane-system"
      - name: create-secrets
        template: create-secrets
        arguments:
          parameters:
          - name: endpoint
            value: "{{`{{tasks.find-secret.outputs.parameters.endpoint}}`}}"
          - name: root-password
            value: "{{`{{tasks.find-secret.outputs.parameters.root-password}}`}}"
        dependencies: [find-secret]
      - name: wait-for-mysql
        template: wait-for-mysql
        dependencies: [create-secrets]
      - name: create-users
        template: create-users
        dependencies: [wait-for-mysql]

  - name: find-secret
    inputs:
      parameters:
      - name: connection-secret-namespace
    retryStrategy:
      limit: 60
      retryPolicy: "Always"
      backoff:
        duration: "30s"
    container:
      image: alpine/k8s:1.32.8
      command: ["/bin/sh", "-c"]
      args:
      - |
        echo "Searching for devlake MySQL secret in {{`{{inputs.parameters.connection-secret-namespace}}`}}..."
        
        # List all secrets for debugging
        echo "Available secrets:"
        kubectl get secrets -n {{`{{inputs.parameters.connection-secret-namespace}}`}} -o name | grep -i mysql || echo "No MySQL secrets found"
        
        # Try multiple patterns to find the secret
        SECRET_NAME=$(kubectl get secrets -n {{`{{inputs.parameters.connection-secret-namespace}}`}} -o name | grep -E "devlake.*mysql.*connection|mysql.*devlake.*connection" | head -1 | cut -d'/' -f2)
        
        if [ -z "$SECRET_NAME" ]; then
          echo "Secret not found yet, will retry..."
          exit 1
        fi
        
        echo "Found secret: $SECRET_NAME"
        
        # Check if password is available in the secret - try multiple possible field names
        endpoint=$(kubectl get secret ${SECRET_NAME} -n {{`{{inputs.parameters.connection-secret-namespace}}`}} -o jsonpath='{.data.endpoint}' 2>/dev/null | base64 -d 2>/dev/null || true)
        
        # Try different password field names
        password=$(kubectl get secret ${SECRET_NAME} -n {{`{{inputs.parameters.connection-secret-namespace}}`}} -o jsonpath='{.data.attribute\.master_password}' 2>/dev/null | base64 -d 2>/dev/null || true)
        if [ -z "$password" ]; then
          password=$(kubectl get secret ${SECRET_NAME} -n {{`{{inputs.parameters.connection-secret-namespace}}`}} -o jsonpath='{.data.password}' 2>/dev/null | base64 -d 2>/dev/null || true)
        fi
        if [ -z "$password" ]; then
          password=$(kubectl get secret ${SECRET_NAME} -n {{`{{inputs.parameters.connection-secret-namespace}}`}} -o jsonpath='{.data.master_password}' 2>/dev/null | base64 -d 2>/dev/null || true)
        fi

        if [ -z "$password" ] || [ -z "$endpoint" ]; then
          echo "Secret found but required values not available yet"
          echo "Endpoint: ${endpoint:-MISSING}"
          echo "Password: ${password:+PRESENT}"
          exit 1
        fi
        
        echo "Secret ready with all required values"
        mkdir -p /tmp
        echo $endpoint > /tmp/endpoint
        echo $password > /tmp/root-password
    outputs:
      parameters:
      - name: endpoint
        valueFrom:
          path: /tmp/endpoint
      - name: root-password
        valueFrom:
          path: /tmp/root-password

  - name: create-secrets
    inputs:
      parameters:
      - name: endpoint
      - name: root-password
    volumes:
    - name: external-passwords
      secret:
        secretName: mysql-passwords
        optional: false
    container:
      image: alpine/k8s:1.32.8
      volumeMounts:
      - name: external-passwords
        mountPath: /passwords
        readOnly: true
      command: ["/bin/sh", "-c"]
      args:
      - |
        endpoint="{{`{{inputs.parameters.endpoint}}`}}"
        root_password="{{`{{inputs.parameters.root-password}}`}}"

        # Read external passwords secret
        merico_password=$(kubectl get secret mysql-passwords -n devlake -o jsonpath='{.data.DEVLAKE_MYSQL_PASSWORD}' | base64 -d)
        grafana_password=$(kubectl get secret mysql-passwords -n devlake -o jsonpath='{.data.GRAFANA_MYSQL_PASSWORD}' | base64 -d)
        
        # Create service pointing to the RDS endpoint
        kubectl delete service devlake-mysql-service -n devlake --ignore-not-found
        kubectl create service externalname devlake-mysql-service --external-name="${endpoint}" -n devlake --dry-run=client -o yaml | kubectl apply -f -
        
        # Create auth secret with credentials
        kubectl delete secret devlake-mysql-auth -n devlake --ignore-not-found
        kubectl create secret generic devlake-mysql-auth -n devlake \
          --from-literal=MYSQL_USER=merico \
          --from-literal=MYSQL_PASSWORD="$merico_password" \
          --from-literal=MYSQL_DATABASE=lake \
          --from-literal=MYSQL_ROOT_PASSWORD="$root_password" \
          --from-literal=DB_URL="mysql://merico:"$merico_password"@devlake-mysql-service:3306/lake?charset=utf8mb4&parseTime=True" \
          --from-literal=EXTERNAL_URL="$endpoint" \
          --dry-run=client -o yaml | kubectl apply -f -

  - name: wait-for-mysql
    retryStrategy:
      limit: 60
      retryPolicy: "Always"
      backoff:
        duration: "15s"
        factor: 1.5
        maxDuration: "300s"
    container:
      image: mysql:8
      command: ["/bin/bash", "-c"]
      args:
      - |
        echo "Waiting for MySQL to be fully initialized..."
        echo "Endpoint: devlake-mysql-service:3306"
        
        # Initial wait for RDS to be ready
        sleep 30
        
        # Test connection
        if mysql -h devlake-mysql-service -P 3306 -u root -p${MYSQL_ROOT_PASSWORD} -e "SELECT 1" 2>&1; then
          echo "MySQL is ready!"
          exit 0
        else
          echo "MySQL not ready yet, will retry..."
          echo "This is normal for RDS instances which can take several minutes to initialize"
          exit 1
        fi
      env:
      - name: MYSQL_ROOT_PASSWORD
        valueFrom:
          secretKeyRef:
            name: devlake-mysql-auth
            key: MYSQL_ROOT_PASSWORD

  - name: create-users
    container:
      image: mysql:8
      command: ["/bin/bash", "-c"]
      args:
      - |
        echo "Creating lake database..."
        mysql -h devlake-mysql-service -P 3306 -u root -p${MYSQL_ROOT_PASSWORD} -e "
        CREATE DATABASE IF NOT EXISTS lake;
        "
        
        echo "Creating devlake user..."
        mysql -h devlake-mysql-service -P 3306 -u root -p${MYSQL_ROOT_PASSWORD} -e "
        CREATE USER IF NOT EXISTS 'merico' IDENTIFIED BY '${MERICO_PASSWORD}';
        GRANT ALL PRIVILEGES ON lake.* TO 'merico';
        FLUSH PRIVILEGES;
        "
      
        echo "Creating Grafana user..."
        mysql -h devlake-mysql-service -P 3306 -u root -p${MYSQL_ROOT_PASSWORD} -e "
        CREATE USER IF NOT EXISTS 'grafanaReader' IDENTIFIED BY '${GRAFANA_PASSWORD}';
        GRANT SELECT ON lake.* TO 'grafanaReader';
        FLUSH PRIVILEGES;
        "
        echo "User creation completed."
      env:
      - name: MYSQL_ROOT_PASSWORD
        valueFrom:
          secretKeyRef:
            name: devlake-mysql-auth
            key: MYSQL_ROOT_PASSWORD
      - name: MERICO_PASSWORD
        valueFrom:
          secretKeyRef:
            name: devlake-mysql-auth
            key: MYSQL_PASSWORD
      - name: GRAFANA_PASSWORD
        valueFrom:
          secretKeyRef:
            name: mysql-passwords
            key: GRAFANA_MYSQL_PASSWORD
