apiVersion: v1
kind: Namespace
metadata:
  name: backstage
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backstage
  namespace: backstage
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: backstage-argo-worfklows
rules:
  - apiGroups:
      - argoproj.io
    resources:
      - workflows
      - applications
    verbs:
      - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: read-all
rules:
  - apiGroups:
      - '*'
    resources:
      - '*'
    verbs:
      - get
      - list
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: backstage-argo-worfklows
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: backstage-argo-worfklows
subjects:
  - kind: ServiceAccount
    name: backstage
    namespace: backstage
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: backstage-read-all
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: read-all
subjects:
  - kind: ServiceAccount
    name: backstage
    namespace: backstage
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backstage-config
  namespace: backstage
data:
  app-config.yaml: |
    app:
      title: Internal Developer Platform
      baseUrl: https://{{ .Values.ingress_domain_name }}/backstage
    organization:
      name: Internal Developer Platform
    backend:
      # Used for enabling authentication, secret is shared by all backend plugins
      # See https://backstage.io/docs/tutorials/backend-to-backend-auth for
      # information on the format
      # auth:
      #   keys:
      #     - secret: ${BACKEND_SECRET}
      baseUrl: https://{{ .Values.ingress_domain_name }}/backstage
      listen:
        port: 7007
        # Uncomment the following host directive to bind to specific interfaces
        # host: 127.0.0.1
      csp:
        connect-src: ["'self'", 'http:', 'https:']
        # Content-Security-Policy directives follow the Helmet format: https://helmetjs.github.io/#reference
        # Default Helmet Content-Security-Policy values can be removed by setting the key to false
      cors:
        origin: https://{{ .Values.ingress_domain_name }}/backstage
        methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
        credentials: true
      database:
        client: pg
        connection:
          host: ${POSTGRES_HOST}
          port: ${POSTGRES_PORT}
          user: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
      cache:
        store: memory
      # workingDirectory: /tmp # Use this to configure a working directory for the scaffolder, defaults to the OS temp-dir

    integrations:
      gitlab:
        - token: ${GIT_PASSWORD}
          apiBaseUrl: https://${GIT_HOSTNAME}/api/v4
          baseUrl: https://${GIT_HOSTNAME}
          host: ${GIT_HOSTNAME}
    #  gitea:
    #   - baseUrl: https://cnoe.localtest.me:8443/gitea
    #     host: cnoe.localtest.me:8443
    #     username: ${GITEA_USERNAME}
    #     password: ${GITEA_PASSWORD}
    #   - baseUrl: https://cnoe.localtest.me/gitea
    #     host: cnoe.localtest.me
    #     username: ${GITEA_USERNAME}
    #     password: ${GITEA_PASSWORD}
    #  github:
    #    - host: github.com
    #      apps:
    #        - $include: github-integration.yaml
    #    - host: github.com
    #      # This is a Personal Access Token or PAT from GitHub. You can find out how to generate this token, and more information
    #      # about setting up the GitHub integration here: https://backstage.io/docs/getting-started/configuration#setting-up-a-github-integration
    #      token: ${GITHUB_TOKEN}
        ### Example for how to add your GitHub Enterprise instance using the API:
        # - host: ghe.example.net
        #   apiBaseUrl: https://ghe.example.net/api/v3
        #   token: ${GHE_TOKEN}

    proxy:
      ### Example for how to add a proxy endpoint for the frontend.
      ### A typical reason to do this is to handle HTTPS and CORS for internal services.
      endpoints:
        '/provisioner': https://${DOMAIN_NAME}/

    # Reference documentation http://backstage.io/docs/features/techdocs/configuration
    # Note: After experimenting with basic setup, use CI/CD to generate docs
    # and an external cloud storage when deploying TechDocs for production use-case.
    # https://backstage.io/docs/features/techdocs/how-to-guides#how-to-migrate-from-techdocs-basic-to-recommended-deployment-approach
    techdocs:
      builder: 'local' # Alternatives - 'external'
      generator:
        runIn: 'local'
      publisher:
        type: 'local' # Alternatives - 'googleGcs' or 'awsS3'. Read documentation for using alternatives.

    auth:
      environment: development
      session:
        secret: MW2sV-sIPngEl26vAzatV-6VqfsgAx4bPIz7PuE_2Lk=
      providers:
        keycloak-oidc:
          development:
            metadataUrl: ${KEYCLOAK_NAME_METADATA}
            clientId: backstage
            clientSecret: ${KEYCLOAK_CLIENT_SECRET}
            prompt: auto

    scaffolder:
      # see https://backstage.io/docs/features/software-templates/configuration for software template options
        defaultAuthor:
          name: backstage-scaffolder
          email: noreply
        defaultCommitMessage: "backstage scaffolder"
    catalog:
      import:
        entityFilename: catalog-info.yaml
        pullRequestBranchName: backstage-integration
      rules:
        - allow: [Component, System, API, Resource, Location, Template]
      locations:
        # Templates from Gitlab.
        - type: url
          target: https://${GIT_HOSTNAME}/${GIT_USERNAME}/${WORKING_REPO}/-/blob/main/platform/backstage/templates/catalog-info.yaml
          rules:
            - allow: [ Component, System, API, Resource, Location, Template, User, Group ]
    kubernetes:
      serviceLocatorMethod:
        type: 'multiTenant'
      clusterLocatorMethods:
        - $include: k8s-config.yaml
    argocd:
      username: admin
      password: ${ARGOCD_ADMIN_PASSWORD}
      appLocatorMethods:
        - type: 'config'
          instances:
            - name: in-cluster
              url: https://${DOMAIN_NAME}/argocd
              username: admin
              password: ${ARGOCD_ADMIN_PASSWORD}
    argoWorkflows:
        baseUrl: ${ARGO_WORKFLOWS_URL}
---
apiVersion: v1
kind: Secret
metadata:
  name: k8s-config
  namespace: backstage
stringData:
  k8s-config.yaml: "type: 'config'\nclusters:\n  - url: https://kubernetes.default.svc.cluster.local\n
    \   name: local\n    authProvider: 'serviceAccount'\n    skipTLSVerify: true\n
    \   skipMetricsLookup: true\n    serviceAccountToken: \n      $file: /var/run/secrets/kubernetes.io/serviceaccount/token\n
    \   caData: \n      $file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n
    \ - url: K8S_SERVER\n
    \   name: workshop\n    authProvider: 'serviceAccount'\n    skipTLSVerify: true\n
    \   skipMetricsLookup: true\n    serviceAccountToken: SA_TOKEN\n"
---
apiVersion: v1
kind: Service
metadata:
  name: backstage
  namespace: backstage
spec:
  ports:
    - name: http
      port: 7007
      targetPort: http
  selector:
    app: backstage
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: postgresql
  name: postgresql
  namespace: backstage
spec:
  clusterIP: None
  ports:
    - name: postgres
      port: 5432
  selector:
    app: postgresql
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backstage
  namespace: backstage
  annotations:
    argocd.argoproj.io/sync-wave: "25"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backstage
  template:
    metadata:
      labels:
        app: backstage
    spec:
      initContainers:
        - name: wait-for-secrets
          image: busybox:1.35
          command:
            - sh
            - -c
            - |
              echo "Waiting for backstage-oidc-vars secret to be ready..."
              MAX_RETRIES=30
              RETRY_COUNT=0
              
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if [ -f /var/secrets/KEYCLOAK_CLIENT_SECRET ] && [ -s /var/secrets/KEYCLOAK_CLIENT_SECRET ]; then
                  echo "Secret is ready!"
                  CLIENT_SECRET=$(cat /var/secrets/KEYCLOAK_CLIENT_SECRET)
                  if [ ${#CLIENT_SECRET} -gt 10 ]; then
                    echo "Secret validation passed (length: ${#CLIENT_SECRET})"
                    exit 0
                  else
                    echo "Secret exists but appears invalid (length: ${#CLIENT_SECRET})"
                  fi
                else
                  echo "Secret not ready yet..."
                fi
                
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "Attempt $RETRY_COUNT/$MAX_RETRIES - waiting 10 seconds..."
                sleep 10
              done
              
              echo "ERROR: Secret not ready after $MAX_RETRIES attempts"
              exit 1
          volumeMounts:
            - name: backstage-oidc-vars
              mountPath: /var/secrets
              readOnly: true
      containers:
        - command:
            - node
            - packages/backend
            - --config
            - config/app-config.yaml
          env:
            - name: LOG_LEVEL
              value: debug
            - name: NODE_TLS_REJECT_UNAUTHORIZED
              value: "0"
            - name: NODE_EXTRA_CA_CERTS
              value: "/app/config/ca.crt"
            - name: DOMAIN_NAME
              value: {{ .Values.ingress_domain_name }}
            - name: NODE_ENV
              value: development
            - name: NODE_OPTIONS
              value: --no-node-snapshot
          envFrom:
            - secretRef:
                name: backstage-env-vars
            - secretRef:
                name: backstage-oidc-vars
            - secretRef:
                name: backstage-postgres-vars
            - secretRef:
                name: git-credentials
            - secretRef:
                name: argocd-credentials
          image: {{ .Values.backstage_image }}
          name: backstage
          ports:
            - containerPort: 7007
              name: http
          volumeMounts:
            - mountPath: /app/config
              name: backstage-config
              readOnly: true
      serviceAccountName: backstage
      volumes:
        - name: backstage-config
          projected:
            sources:
              - configMap:
                  items:
                    - key: app-config.yaml
                      path: app-config.yaml
                  name: backstage-config
              - secret:
                  items:
                    - key: k8s-config.yaml
                      path: k8s-config.yaml
                  name: k8s-config
        - name: backstage-env-vars
          secret:
            secretName: backstage-env-vars
        - name: backstage-oidc-vars
          secret:
            secretName: backstage-oidc-vars
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: postgresql
  name: postgresql
  namespace: backstage
  annotations:
    argocd.argoproj.io/sync-wave: "10"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgresql
  serviceName: service-postgresql
  template:
    metadata:
      labels:
        app: postgresql
    spec:
      containers:
        - env:
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: backstage-env-vars
                  key: POSTGRES_DB
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: backstage-env-vars
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: backstage-postgres-vars
                  key: POSTGRES_PASSWORD
          image: docker.io/library/postgres:17.4-alpine3.21
          name: postgres
          ports:
            - containerPort: 5432
              name: postgresdb
          resources:
            limits:
              memory: 500Mi
            requests:
              cpu: 100m
              memory: 300Mi
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      volumeMode: Filesystem
      resources:
        requests:
          storage: "500Mi"
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: backstage-oidc
  namespace: backstage
  annotations:
    argocd.argoproj.io/sync-wave: "15"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  secretStoreRef:
    name: keycloak
    kind: ClusterSecretStore
  refreshInterval: "30s"
  target:
    name: backstage-oidc-vars
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      engineVersion: v2
      mergePolicy: Replace
      data:
        KEYCLOAK_CLIENT_SECRET: "{{ `{{.BACKSTAGE_CLIENT_SECRET}}` }}"
        ARGOCD_AUTH_TOKEN: "argocd.token={{ `{{.ARGOCD_SESSION_TOKEN}}` }}"
  data:
    - secretKey: ARGOCD_SESSION_TOKEN
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        key: keycloak-clients
        metadataPolicy: None
        property: ARGOCD_SESSION_TOKEN
    - secretKey: BACKSTAGE_CLIENT_SECRET
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        key: keycloak-clients
        metadataPolicy: None
        property: BACKSTAGE_CLIENT_SECRET
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: backstage-postgres
  namespace: backstage
  annotations:
    argocd.argoproj.io/sync-wave: "5"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  refreshInterval: "30s"
  target:
    name: backstage-postgres-vars
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      engineVersion: v2
      mergePolicy: Replace
      data:
        POSTGRES_PASSWORD: "{{ `{{.password}}` }}"
  data:
    - secretKey: password
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        key: peeks-workshop-gitops-backstage-postgresql-password
        metadataPolicy: None
        property: password
---
apiVersion: v1
kind: Secret
metadata:
  name: backstage-env-vars
  namespace: backstage
  annotations:
    argocd.argoproj.io/sync-wave: "20"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
  labels:
    app.kubernetes.io/name: backstage
    app.kubernetes.io/component: config
type: Opaque
stringData:
  BACKSTAGE_FRONTEND_URL: https://{{ .Values.ingress_domain_name }}/backstage
  POSTGRES_HOST: postgresql.backstage.svc.cluster.local
  POSTGRES_PORT: '5432'
  POSTGRES_DB: backstage
  POSTGRES_USER: backstage
  ARGO_WORKFLOWS_URL: https://{{ .Values.ingress_domain_name }}/argo-workflows
  KEYCLOAK_NAME_METADATA: https://{{ .Values.ingress_domain_name }}/keycloak/realms/platform/.well-known/openid-configuration
  ARGO_CD_URL: 'https://argocd-server.argocd.svc.cluster.local/api/v1/'
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: backstage
  namespace: backstage
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  ingressClassName: "nginx"
  rules:
    - host: {{ .Values.ingress_domain_name }}
      http:
        paths:
          - path: /backstage(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: backstage
                port:
                  name: http
