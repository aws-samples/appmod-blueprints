{{- if .Values.compositions.enabled }}
---
apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: xobjectstorages.awsblueprints.io
  annotations:
    argocd.argoproj.io/sync-wave: "20"
spec:
  claimNames:
    kind: ObjectStorage
    plural: objectstorages
  group: awsblueprints.io
  names:
    kind: XObjectStorage
    plural: xobjectstorages
  connectionSecretKeys:
    - region
    - bucket-name
    - s3-put-policy
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          properties:
            spec:
              description: ObjectStorageSpec defines the desired state of ObjectStorage
              properties:
                resourceConfig:
                  description: ResourceConfig defines general properties of this AWS resource.
                  properties:
                    deletionPolicy:
                      description: Defaults to Delete
                      enum:
                      - Delete
                      - Orphan
                      type: string
                    name:
                      description: Set the name of this resource in AWS to the value provided by this field.
                      type: string
                    providerConfigName:
                      type: string
                    region:
                      type: string
                    tags:
                      items:
                        properties:
                          key:
                            type: string
                          value:
                            type: string
                        required:
                        - key
                        - value
                        type: object
                      type: array
                  required:
                  - providerConfigName
                  - region
                  - tags
                  type: object
              required:
              - resourceConfig
              type: object
            status:
              description: ObjectStorageStatus defines the observed state of ObjectStorage
              properties:
                bucketName:
                  type: string
                bucketArn:
                  type: string
              type: object
          type: object
---
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: s3bucket.awsblueprints.io
  labels:
    awsblueprints.io/provider: aws
    awsblueprints.io/environment: dev
    s3.awsblueprints.io/configuration: standard
  annotations:
    argocd.argoproj.io/sync-wave: "25"
spec:
  writeConnectionSecretsToNamespace: crossplane-system
  compositeTypeRef:
    apiVersion: awsblueprints.io/v1alpha1
    kind: XObjectStorage
  mode: Pipeline
  pipeline:
    - step: s3-bucket
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          - name: bucket
            base:
              apiVersion: s3.aws.upbound.io/v1beta2
              kind: Bucket
              spec:
                forProvider:
                  region: us-west-2
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.providerConfigName
                toFieldPath: spec.providerConfigRef.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.name
                toFieldPath: metadata.annotations[crossplane.io/external-name]
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.region
                toFieldPath: spec.forProvider.region
              - type: ToCompositeFieldPath
                fromFieldPath: metadata.annotations[crossplane.io/external-name]
                toFieldPath: status.bucketName
              - type: ToCompositeFieldPath
                fromFieldPath: status.atProvider.arn
                toFieldPath: status.bucketArn
              - fromFieldPath: metadata.uid
                toFieldPath: spec.writeConnectionSecretToRef.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-bucket"
              - fromFieldPath: spec.writeConnectionSecretToRef.namespace
                toFieldPath: spec.writeConnectionSecretToRef.namespace
            connectionDetails:
              - name: bucket-name
                type: FromFieldPath
                fromFieldPath: metadata.annotations[crossplane.io/external-name]
              - name: region
                type: FromValue
                value: us-west-2
          - name: bucket-public-access-block
            base:
              apiVersion: s3.aws.upbound.io/v1beta1
              kind: BucketPublicAccessBlock
              spec:
                forProvider:
                  bucketSelector:
                    matchControllerRef: true
                  blockPublicPolicy: true
                  restrictPublicBuckets: true
                  region: us-west-2
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.providerConfigName
                toFieldPath: spec.providerConfigRef.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.region
                toFieldPath: spec.forProvider.region
          - name: bucket-ownership
            base:
              apiVersion: s3.aws.upbound.io/v1beta2
              kind: BucketOwnershipControls
              spec:
                forProvider:
                  bucketSelector:
                    matchControllerRef: true
                  rule:
                    objectOwnership: BucketOwnerEnforced
                  region: us-west-2
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.providerConfigName
                toFieldPath: spec.providerConfigRef.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.region
                toFieldPath: spec.forProvider.region
          - name: bucket-sse
            base:
              apiVersion: s3.aws.upbound.io/v1beta2
              kind: BucketServerSideEncryptionConfiguration
              spec:
                forProvider:
                  bucketSelector:
                    matchControllerRef: true
                  rule:
                    - applyServerSideEncryptionByDefault:
                        sseAlgorithm: AES256
                  region: us-west-2
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.providerConfigName
                toFieldPath: spec.providerConfigRef.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.region
                toFieldPath: spec.forProvider.region
---
apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: xdynamodbtables.awsblueprints.io
  annotations:
    argocd.argoproj.io/sync-wave: "20"
spec:
  group: awsblueprints.io
  names:
    kind: XDynamoDBTable
    plural: xdynamodbtables
  claimNames:
    kind: DynamoDBTable
    plural: dynamodbtables
  connectionSecretKeys:
    - tableName
    - tableArn
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          properties:
            spec:
              properties:
                dynamoConfig:
                  properties:
                    attribute:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          type:
                            type: string
                    hashKey:
                      type: string
                    rangeKey:
                      type: string
                    billingMode:
                      type: string
                      default: "PROVISIONED"
                    readCapacity:
                      type: integer
                      default: 20
                    writeCapacity:
                      type: integer
                      default: 20
                    globalSecondaryIndex:
                      type: array
                      items:
                        type: object
                    localSecondaryIndex:
                      type: array
                      items:
                        type: object
                  required:
                    - hashKey
                  type: object
                resourceConfig:
                  description: ResourceConfig defines general properties of this AWS resource.
                  properties:
                    deletionPolicy:
                      description: Defaults to Delete
                      enum:
                      - Delete
                      - Orphan
                      type: string
                    name:
                      description: Set the name of this resource in AWS to the value provided by this field.
                      type: string
                    providerConfigName:
                      type: string
                    region:
                      type: string
                    tags:
                      additionalProperties:
                        type: string
                      type: object
                  required:
                  - providerConfigName
                  - region
                  type: object
              required:
              - dynamoConfig
              - resourceConfig
              type: object
            status:
              properties:
                tableName:
                  type: string
                tableArn:
                  type: string
              type: object
          type: object
---
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: table.dynamodb.awsblueprints.io
  labels:
    awsblueprints.io/provider: aws
    awsblueprints.io/environment: dev
  annotations:
    argocd.argoproj.io/sync-wave: "25"
spec:
  writeConnectionSecretsToNamespace: crossplane-system
  compositeTypeRef:
    apiVersion: awsblueprints.io/v1alpha1
    kind: XDynamoDBTable
  mode: Pipeline
  pipeline:
    - step: render
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        patchSets:
          - name: common-fields
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.providerConfigName
                toFieldPath: spec.providerConfigRef.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.name
                toFieldPath: metadata.annotations[crossplane.io/external-name]
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.region
                toFieldPath: spec.forProvider.region
        resources:
          - name: table
            connectionDetails:
              - type: FromFieldPath
                name: tableName
                fromFieldPath: status.atProvider.id
            base:
              apiVersion: dynamodb.aws.upbound.io/v1beta1
              kind: Table
            patches:
              - type: PatchSet
                patchSetName: common-fields
              - type: FromCompositeFieldPath
                fromFieldPath: spec.dynamoConfig.attribute
                toFieldPath: spec.forProvider.attribute
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.tags
                toFieldPath: spec.forProvider.tags
              - type: FromCompositeFieldPath
                fromFieldPath: spec.dynamoConfig.hashKey
                toFieldPath: spec.forProvider.hashKey
              - type: FromCompositeFieldPath
                fromFieldPath: spec.dynamoConfig.billingMode
                toFieldPath: spec.forProvider.billingMode
              - type: FromCompositeFieldPath
                fromFieldPath: spec.dynamoConfig.rangeKey
                toFieldPath: spec.forProvider.rangeKey
              - type: FromCompositeFieldPath
                fromFieldPath: spec.dynamoConfig.readCapacity
                toFieldPath: spec.forProvider.readCapacity 
              - type: FromCompositeFieldPath
                fromFieldPath: spec.dynamoConfig.writeCapacity
                toFieldPath: spec.forProvider.writeCapacity
              - type: FromCompositeFieldPath
                fromFieldPath: spec.dynamoConfig.globalSecondaryIndex
                toFieldPath: spec.forProvider.globalSecondaryIndex
              - type: FromCompositeFieldPath
                fromFieldPath: spec.dynamoConfig.localSecondaryIndex
                toFieldPath: spec.forProvider.localSecondaryIndex
              - type: ToCompositeFieldPath
                fromFieldPath: status.atProvider.id
                toFieldPath: status.tableName
              - type: ToCompositeFieldPath
                fromFieldPath: status.atProvider.arn
                toFieldPath: status.tableArn
---
apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: xrelationaldatabases.awsblueprints.io
  annotations:
    argocd.argoproj.io/sync-wave: "20"
spec:
  group: awsblueprints.io
  names:
    kind: XRelationalDatabase
    plural: xrelationaldatabases
  claimNames:
    kind: RelationalDatabase
    plural: relationaldatabases
  connectionSecretKeys:
    - username
    - password
    - endpoint
    - port
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          properties:
            spec:
              properties:
                databaseName:
                  type: string
                dbSubnetGroupName:
                  type: string
                engineVersion: 
                  type: string
                storageGB:
                  type: integer
                subnetIds:
                  type: array
                  items:
                    type: string
                  minItems: 1
                vpcId: 
                  type: string
                IngressRules:
                  type: array
                  items:
                    type: object
                    properties:
                      ipProtocol:
                        type: string
                      fromPort:
                        type: integer
                      toPort:
                        type: integer
                      ipRanges:
                        type: array
                        items:
                          type: object
                          properties:
                            cidrIp:
                              type: string
                resourceConfig:
                  description: ResourceConfig defines general properties of this AWS resource.
                  properties:
                    deletionPolicy:
                      description: Defaults to Delete
                      enum:
                      - Delete
                      - Orphan
                      type: string
                    name:
                      description: Set the name of this resource in AWS to the value provided by this field.
                      type: string
                    providerConfigName:
                      type: string
                    region:
                      type: string
                    tags:
                      items:
                        properties:
                          key:
                            type: string
                          value:
                            type: string
                        required:
                        - key
                        - value
                        type: object
                      type: array
                  required:
                  - providerConfigName
                  - region
                  - tags
                  type: object
              required:
              - resourceConfig
              type: object
            status:
              properties:
                securityGroupId:
                  type: string
                clusterId:
                  type: string
              type: object
          type: object
---
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: rds-postgresql.awsblueprints.io
  labels:
    awsblueprints.io/provider: aws
    awsblueprints.io/environment: dev
    awsblueprints.io/createDBSubnetGroup: "true"
  annotations:
    argocd.argoproj.io/sync-wave: "25"
spec:
  writeConnectionSecretsToNamespace: crossplane-system
  compositeTypeRef:
    apiVersion: awsblueprints.io/v1alpha1
    kind: XRelationalDatabase
  mode: Pipeline
  pipeline:
    - step: rds-resources
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          - name: db-subnet-group
            base:
              apiVersion: rds.aws.upbound.io/v1beta1
              kind: SubnetGroup
              spec:
                forProvider:
                  description: "rds-postgres"
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.providerConfigName
                toFieldPath: spec.providerConfigRef.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.deletionPolicy
                toFieldPath: spec.deletionPolicy
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.region
                toFieldPath: spec.forProvider.region
              - fromFieldPath: spec.writeConnectionSecretToRef.namespace
                toFieldPath: spec.writeConnectionSecretToRef.namespace
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.name
                toFieldPath: metadata.annotations[crossplane.io/external-name]
              - fromFieldPath: "spec.subnetIds"
                toFieldPath: spec.forProvider.subnetIds
              - fromFieldPath: "metadata.uid"
                toFieldPath: "spec.writeConnectionSecretToRef.name"
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-dbsubnet"
          - name: security-group
            base:
              apiVersion: ec2.aws.upbound.io/v1beta1
              kind: SecurityGroup
              spec:
                forProvider:
                  description: "rds-postgres-sg"
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.providerConfigName
                toFieldPath: spec.providerConfigRef.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.region
                toFieldPath: spec.forProvider.region
              - fromFieldPath: "spec.vpcId"
                toFieldPath: "spec.forProvider.vpcId"
          - name: db-instance
            base:
              apiVersion: rds.aws.upbound.io/v1beta3
              kind: Instance
              spec:
                forProvider:
                  applyImmediately: true
                  backupRetentionPeriod: 3
                  dbSubnetGroupNameSelector:
                    matchControllerRef: true
                  instanceClass: db.t4g.small
                  username: root
                  passwordSecretRef:
                    key: password
                    name: test-postgres-password
                    namespace: crossplane-system
                  engine: postgres
                  engineVersion: "14.12"
                  skipFinalSnapshot: true
                  storageEncrypted: true
                  storageType: gp3
                  publiclyAccessible: false
                  vpcSecurityGroupIdSelector:
                    matchControllerRef: true
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.providerConfigName
                toFieldPath: spec.providerConfigRef.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.deletionPolicy
                toFieldPath: spec.deletionPolicy
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.region
                toFieldPath: spec.forProvider.region
              - fromFieldPath: spec.writeConnectionSecretToRef.namespace
                toFieldPath: spec.writeConnectionSecretToRef.namespace
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resourceConfig.name
                toFieldPath: metadata.annotations[crossplane.io/external-name]
              - fromFieldPath: "metadata.uid"
                toFieldPath: "spec.writeConnectionSecretToRef.name"
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-postgresql"
              - fromFieldPath: "spec.storageGB"
                toFieldPath: "spec.forProvider.allocatedStorage"
              - fromFieldPath: "spec.engineVersion"
                toFieldPath: "spec.forProvider.engineVersion"
              - fromFieldPath: "spec.databaseName"
                toFieldPath: "spec.forProvider.dbName"
            connectionDetails:
              - name: username
                type: FromConnectionSecretKey
                fromConnectionSecretKey: username
              - name: password
                type: FromConnectionSecretKey
                fromConnectionSecretKey: password
              - name: endpoint
                type: FromConnectionSecretKey
                fromConnectionSecretKey: endpoint
              - name: port
                type: FromConnectionSecretKey
                fromConnectionSecretKey: port
{{- end }}
