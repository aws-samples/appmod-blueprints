apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.clusterName }}-cluster
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  refreshInterval: 30s
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: {{ .Values.clusterName }}
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          argocd.argoproj.io/secret-type: cluster
          aws_cluster_name: "{{ .Values.clusterName }}"
          cluster_name: "{{ .Values.clusterName }}"
          environment: staging
          tenant: "{{ .Values.tenant }}"
          fleet_member: staging
          {{- range $key, $value := .Values.enabledAddons }}
          {{ $key }}: "{{ $value }}"
          {{- end }}
        annotations:
          aws_account_id: "665742499430"
          aws_region: "us-east-1"
          aws_cluster_name: "{{ .Values.clusterName }}"
          cluster_name: "{{ .Values.clusterName }}"
          environment: staging
          aws_vpc_id: "vpc-026f1f5f724971a97"
          ingress_security_groups: "sg-045729cca7534dba2,sg-0acc5c0ddc9486c71"
          addons_repo_url: "https://d1vvjck0a1cre3.cloudfront.net/user1/platform-on-eks-workshop.git"
          addons_repo_basepath: "gitops/addons/"
          addons_repo_path: "bootstrap"
          addons_repo_revision: "main"
          fleet_repo_url: "https://d1vvjck0a1cre3.cloudfront.net/user1/platform-on-eks-workshop.git"
          fleet_repo_basepath: "gitops/fleet/"
          fleet_repo_path: "bootstrap"
          fleet_repo_revision: "main"
          workload_repo_url: "https://d1vvjck0a1cre3.cloudfront.net/user1/platform-on-eks-workshop.git"
          workload_repo_basepath: "gitops/workloads/"
          workload_repo_path: ""
          workload_repo_revision: "main"
          ingress_domain_name: "dlu6mbvnpgi1g.cloudfront.net"
          gitlab_domain_name: "d1vvjck0a1cre3.cloudfront.net"
          argocd_namespace: "argocd"
          create_argocd_namespace: "false"
          external_secrets_namespace: "external-secrets"
          external_secrets_service_account: "external-secrets-sa"
          git_username: "user1"
          working_repo: "platform-on-eks-workshop"
          use_ack: "true"
      data:
        name: "{{ .Values.clusterName | b64enc }}"
        server: "{{ `{{ .server | b64enc }}` }}"
        config: "{{ `{{ .config | b64enc }}` }}"
  data:
  - secretKey: server
    remoteRef:
      key: {{ .Values.secretKey }}
      property: server
  - secretKey: config
    remoteRef:
      key: {{ .Values.secretKey }}
      property: config
