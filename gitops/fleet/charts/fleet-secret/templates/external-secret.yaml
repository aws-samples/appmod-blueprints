apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.clusterName }}-cluster
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  refreshInterval: 30s
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: {{ .Values.clusterName }}
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          argocd.argoproj.io/secret-type: cluster
          aws_cluster_name: "{{ `{{ .aws_cluster_name }}` }}"
          cluster_name: "{{ `{{ .cluster_name }}` }}"
          environment: "{{ `{{ .environment }}` }}"
          tenant: {{ .Values.tenant | default "tenant1" }}
          fleet_member: "{{ `{{ .environment }}` }}"
          {{- range $key, $value := .Values.enabledAddons }}
          {{ $key }}: "{{ $value }}"
          {{- end }}
        annotations:
          aws_account_id: "{{ `{{ .aws_account_id }}` }}"
          aws_region: "{{ `{{ .aws_region }}` }}"
          aws_cluster_name: "{{ `{{ .aws_cluster_name }}` }}"
          cluster_name: "{{ `{{ .cluster_name }}` }}"
          environment: "{{ `{{ .environment }}` }}"
          aws_vpc_id: "{{ `{{ .aws_vpc_id }}` }}"
          ingress_security_groups: "{{ `{{ .ingress_security_groups }}` }}"
          addons_repo_url: "{{ `{{ .addons_repo_url }}` }}"
          addons_repo_basepath: "{{ `{{ .addons_repo_basepath }}` }}"
          addons_repo_path: "{{ `{{ .addons_repo_path }}` }}"
          addons_repo_revision: "{{ `{{ .addons_repo_revision }}` }}"
          fleet_repo_url: "{{ `{{ .fleet_repo_url }}` }}"
          fleet_repo_basepath: "{{ `{{ .fleet_repo_basepath }}` }}"
          fleet_repo_path: "{{ `{{ .fleet_repo_path }}` }}"
          fleet_repo_revision: "{{ `{{ .fleet_repo_revision }}` }}"
          workload_repo_url: "{{ `{{ .workload_repo_url }}` }}"
          workload_repo_basepath: "{{ `{{ .workload_repo_basepath }}` }}"
          workload_repo_path: "{{ `{{ .workload_repo_path }}` }}"
          workload_repo_revision: "{{ `{{ .workload_repo_revision }}` }}"
          ingress_domain_name: "{{ `{{ .ingress_domain_name }}` }}"
          gitlab_domain_name: "{{ `{{ .gitlab_domain_name }}` }}"
          argocd_namespace: "{{ `{{ .argocd_namespace }}` }}"
          create_argocd_namespace: "{{ `{{ .create_argocd_namespace }}` }}"
          external_secrets_namespace: "{{ `{{ .external_secrets_namespace }}` }}"
          external_secrets_service_account: "{{ `{{ .external_secrets_service_account }}` }}"
          git_username: "{{ `{{ .git_username }}` }}"
          working_repo: "{{ `{{ .working_repo }}` }}"
          use_ack: "{{ `{{ .use_ack }}` }}"
      data:
        name: "{{ .Values.clusterName | b64enc }}"
        server: "{{ `{{ .server | b64enc }}` }}"
        config: "{{ `{{ .config | b64enc }}` }}"
  dataFrom:
  - extract:
      key: {{ .Values.secretKey }}
