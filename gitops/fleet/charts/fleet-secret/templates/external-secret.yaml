apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.clusterName }}-cluster
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  refreshInterval: 30s
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: {{ .Values.clusterName }}
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          argocd.argoproj.io/secret-type: cluster
          aws_cluster_name: "{{ `{{ .aws_cluster_name }}` }}"
          cluster_name: "{{ `{{ .aws_cluster_name }}` }}"
          environment: staging
          tenant: "{{ .Values.tenant }}"
          fleet_member: staging
          {{- range $key, $value := .Values.enabledAddons }}
          {{ $key }}: "{{ $value }}"
          {{- end }}
        annotations:
          aws_account_id: "{{ `{{ .aws_account_id }}` }}"
          aws_region: "{{ `{{ .aws_region }}` }}"
          aws_cluster_name: "{{ `{{ .aws_cluster_name }}` }}"
          cluster_name: "{{ `{{ .aws_cluster_name }}` }}"
          environment: staging
          aws_vpc_id: "{{ `{{ .aws_vpc_id }}` }}"
          ingress_security_groups: "{{ `{{ .ingress_security_groups }}` }}"
          adot_collector_namespace: "{{ `{{ .adot_collector_namespace }}` }}"
          adot_collector_service_account: "{{ `{{ .adot_collector_service_account }}` }}"
          amp_endpoint_url: "{{ `{{ .amp_endpoint_url }}` }}"
          aws_load_balancer_controller_namespace: "{{ `{{ .aws_load_balancer_controller_namespace }}` }}"
          aws_load_balancer_controller_service_account: "{{ `{{ .aws_load_balancer_controller_service_account }}` }}"
          external_secrets_namespace: "{{ `{{ .external_secrets_namespace }}` }}"
          external_secrets_namespace_fleet: "{{ `{{ .external_secrets_namespace_fleet }}` }}"
          external_secrets_service_account: "{{ `{{ .external_secrets_service_account }}` }}"
          external_secrets_service_account_fleet: "{{ `{{ .external_secrets_service_account_fleet }}` }}"
          karpenter_namespace: "{{ `{{ .karpenter_namespace }}` }}"
          karpenter_node_iam_role_name: "{{ `{{ .karpenter_node_iam_role_name }}` }}"
          karpenter_service_account: "{{ `{{ .karpenter_service_account }}` }}"
          karpenter_sqs_queue_name: "{{ `{{ .karpenter_sqs_queue_name }}` }}"
      data:
        name: "{{ .Values.clusterName | b64enc }}"
        server: "{{ `{{ .server | b64enc }}` }}"
        config: "{{ `{{ .config }}` }}"
  data:
  - secretKey: server
    remoteRef:
      key: {{ .Values.secretKey }}
      property: server
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: config
    remoteRef:
      key: {{ .Values.secretKey }}
      property: config
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: aws_cluster_name
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.aws_cluster_name
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: aws_account_id
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.aws_account_id
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: aws_region
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.aws_region
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: aws_vpc_id
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.aws_vpc_id
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: ingress_security_groups
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.ingress_security_groups
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: adot_collector_namespace
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.adot_collector_namespace
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: adot_collector_service_account
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.adot_collector_service_account
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: amp_endpoint_url
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.amp_endpoint_url
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: aws_load_balancer_controller_namespace
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.aws_load_balancer_controller_namespace
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: aws_load_balancer_controller_service_account
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.aws_load_balancer_controller_service_account
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: external_secrets_namespace
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.external_secrets_namespace
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: external_secrets_namespace_fleet
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.external_secrets_namespace_fleet
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: external_secrets_service_account
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.external_secrets_service_account
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: external_secrets_service_account_fleet
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.external_secrets_service_account_fleet
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: karpenter_namespace
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.karpenter_namespace
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: karpenter_node_iam_role_name
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.karpenter_node_iam_role_name
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: karpenter_service_account
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.karpenter_service_account
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
  - secretKey: karpenter_sqs_queue_name
    remoteRef:
      key: {{ .Values.secretKey }}
      property: metadata.karpenter_sqs_queue_name
      conversionStrategy: Default
      decodingStrategy: None
      metadataPolicy: None
