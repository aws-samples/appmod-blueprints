apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.clusterName }}-cluster
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  refreshInterval: 30s
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: {{ .Values.clusterName }}
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          argocd.argoproj.io/secret-type: cluster
          aws_cluster_name: "{{ `{{ .metadata.aws_cluster_name }}` }}"
          cluster_name: "{{ `{{ .metadata.aws_cluster_name }}` }}"
          environment: "{{ `{{ .metadata.environment | default "staging" }}` }}"
          tenant: "{{ .Values.tenant | default "tenant1" }}"
          fleet_member: "{{ `{{ .metadata.environment | default "staging" }}` }}"
          {{- range $key, $value := .Values.enabledAddons }}
          {{ $key }}: "{{ $value }}"
          {{- end }}
        annotations:
          aws_account_id: "{{ `{{ .metadata.aws_account_id }}` }}"
          aws_region: "{{ `{{ .metadata.aws_region }}` }}"
          aws_cluster_name: "{{ `{{ .metadata.aws_cluster_name }}` }}"
          cluster_name: "{{ `{{ .metadata.aws_cluster_name }}` }}"
          environment: "{{ `{{ .metadata.environment | default "staging" }}` }}"
          aws_vpc_id: "{{ `{{ .metadata.aws_vpc_id }}` }}"
          ingress_security_groups: "{{ `{{ .metadata.ingress_security_groups }}` }}"
          addons_repo_url: "{{ `{{ .metadata.addons_repo_url | default "https://d1vvjck0a1cre3.cloudfront.net/user1/platform-on-eks-workshop.git" }}` }}"
          addons_repo_basepath: "{{ `{{ .metadata.addons_repo_basepath | default "gitops/addons/" }}` }}"
          addons_repo_path: "{{ `{{ .metadata.addons_repo_path | default "bootstrap" }}` }}"
          addons_repo_revision: "{{ `{{ .metadata.addons_repo_revision | default "main" }}` }}"
          fleet_repo_url: "{{ `{{ .metadata.fleet_repo_url | default "https://d1vvjck0a1cre3.cloudfront.net/user1/platform-on-eks-workshop.git" }}` }}"
          fleet_repo_basepath: "{{ `{{ .metadata.fleet_repo_basepath | default "gitops/fleet/" }}` }}"
          fleet_repo_path: "{{ `{{ .metadata.fleet_repo_path | default "bootstrap" }}` }}"
          fleet_repo_revision: "{{ `{{ .metadata.fleet_repo_revision | default "main" }}` }}"
          workload_repo_url: "{{ `{{ .metadata.workload_repo_url | default "https://d1vvjck0a1cre3.cloudfront.net/user1/platform-on-eks-workshop.git" }}` }}"
          workload_repo_basepath: "{{ `{{ .metadata.workload_repo_basepath | default "gitops/workloads/" }}` }}"
          workload_repo_path: "{{ `{{ .metadata.workload_repo_path | default "" }}` }}"
          workload_repo_revision: "{{ `{{ .metadata.workload_repo_revision | default "main" }}` }}"
          ingress_domain_name: "{{ `{{ .metadata.ingress_domain_name | default "dlu6mbvnpgi1g.cloudfront.net" }}` }}"
          gitlab_domain_name: "{{ `{{ .metadata.gitlab_domain_name | default "d1vvjck0a1cre3.cloudfront.net" }}` }}"
          argocd_namespace: "{{ `{{ .metadata.argocd_namespace | default "argocd" }}` }}"
          create_argocd_namespace: "{{ `{{ .metadata.create_argocd_namespace | default "false" }}` }}"
          external_secrets_namespace: "{{ `{{ .metadata.external_secrets_namespace | default "external-secrets" }}` }}"
          external_secrets_service_account: "{{ `{{ .metadata.external_secrets_service_account | default "external-secrets-sa" }}` }}"
          git_username: "{{ `{{ .metadata.git_username | default "user1" }}` }}"
          working_repo: "{{ `{{ .metadata.working_repo | default "platform-on-eks-workshop" }}` }}"
          use_ack: "{{ `{{ .metadata.use_ack | default "true" }}` }}"
      data:
        name: "{{ .Values.clusterName | b64enc }}"
        server: "{{ `{{ .server | b64enc }}` }}"
        config: "{{ `{{ .config | b64enc }}` }}"
  dataFrom:
  - extract:
      key: {{ .Values.secretKey }}
