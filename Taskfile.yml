version: '3'

tasks:
  build-helm-dependencies:
    desc: Build Helm chart dependencies for all addon charts that require them
    cmds:
      - echo "Adding required Helm repositories..."
      - helm repo add crossplane-stable https://charts.crossplane.io/stable || true
      - helm repo add kubevela https://kubevela.github.io/charts || true
      - helm repo add fluxcd-community https://fluxcd-community.github.io/helm-charts || true
      - helm repo add apache-airflow https://airflow.apache.org || true
      - helm repo add jupyterhub https://hub.jupyter.org/helm-chart/ || true
      - helm repo add spark-operator https://kubeflow.github.io/spark-operator || true
      - helm repo add mlflow https://community-charts.github.io/helm-charts || true
      - helm repo update
      - echo "Building dependencies for flux chart..."
      - cd ./gitops/addons/charts/flux && helm dependency build
      - echo "Building dependencies for kubevela chart..."
      - cd ./gitops/addons/charts/kubevela && helm dependency build
      - echo "Building dependencies for airflow chart..."
      - cd ./gitops/addons/charts/airflow && helm dependency build
      - echo "Building dependencies for devlake chart..."
      - cd ./gitops/addons/charts/devlake && helm dependency build
      - echo "Building dependencies for jupyterhub chart..."
      - cd ./gitops/addons/charts/jupyterhub && helm dependency build
      - echo "Building dependencies for spark-operator chart..."
      - cd ./gitops/addons/charts/spark-operator && helm dependency build
      - echo "Building dependencies for mlflow chart..."
      - cd ./gitops/addons/charts/mlflow && helm dependency build
      - echo "All Helm chart dependencies built successfully!"
      - echo "Don't forget to commit the generated Chart.lock files and charts/ directories"

  check-helm-dependencies:
    desc: Check which charts have dependencies defined
    cmds:
      - echo "Charts with dependencies:"
      - find ./gitops/addons/charts -name "Chart.yaml" -exec grep -l "dependencies:" {} \;
      - echo ""
      - echo "Checking for missing Chart.lock files:"
      - |
        for chart in $(find ./gitops/addons/charts -name "Chart.yaml" -exec grep -l "dependencies:" {} \;); do
          chart_dir=$(dirname "$chart")
          if [ ! -f "$chart_dir/Chart.lock" ]; then
            echo "Missing Chart.lock: $chart_dir"
          else
            echo "Found Chart.lock: $chart_dir"
          fi
        done

  clean-helm-dependencies:
    desc: Clean all generated Helm dependency files
    cmds:
      - echo "Cleaning Chart.lock files and charts/ directories..."
      - find ./gitops/addons/charts -name "Chart.lock" -delete
      - find ./gitops/addons/charts -name "charts" -type d -exec rm -rf {} + 2>/dev/null || true
      - echo "Cleaned all Helm dependency files"

  test-applicationsets:
    desc: Test ApplicationSet generation locally using helm template
    cmds:
      - |
        cd ./gitops/addons/charts/application-sets && \
        helm template test-appsets . \
          -f ../../bootstrap/default/addons.yaml \
          -f ../../environments/control-plane/addons.yaml \
          --set repoURLGit="https://github.com/aws-samples/appmod-blueprints" \
          --set repoURLGitRevision="main" \
          --set repoURLGitBasePath="gitops/addons/"
        #grep -A 50 -B 5 "name: crossplane-aws"

  test-airflow-chart:
    desc: Test airflow helm chart for bitnami images and validate template rendering
    cmds:
      - echo "ğŸ” Testing airflow helm chart..."
      - echo "Adding Apache Airflow repository..."
      - helm repo add apache-airflow https://airflow.apache.org || true
      - helm repo update
      - echo "Building dependencies for airflow chart..."
      - cd ./gitops/addons/charts/airflow && helm dependency build
      - echo "Testing helm template rendering..."
      - |
        cd ./gitops/addons/charts/airflow && \
        helm template airflow . \
          -f ../../default/addons/airflow/values.yaml \
          --set global.resourcePrefix=peeks \
          --dry-run > /tmp/airflow-test.yaml
      - echo "âœ… Template rendering successful"
      - echo "ğŸ” Checking for problematic bitnami images from docker.io..."
      - |
        if grep -E "image:.*docker\.io/bitnami|repository:.*docker\.io/bitnami" /tmp/airflow-test.yaml; then
          echo "âŒ Found problematic bitnami images from docker.io in airflow chart!"
          exit 1
        else
          echo "âœ… No problematic docker.io bitnami images found"
        fi
      - echo "ğŸ“‹ Images used in airflow chart:"
      - grep -i "image:" /tmp/airflow-test.yaml | grep -v "imagePullPolicy" | sort | uniq
      - rm -f /tmp/airflow-test.yaml
  test-kubeflow-chart:
    desc: Test kubeflow helm chart for bitnami images and validate template rendering
    cmds:
      - echo "ğŸ” Testing kubeflow helm chart..."
      - echo "Testing helm template rendering..."
      - |
        cd ./gitops/addons/charts/kubeflow && \
        helm template kubeflow . \
          -f ../../default/addons/kubeflow/values.yaml \
          --set global.resourcePrefix=peeks \
          --set global.ingress_domain_name=example.com \
          --dry-run > /tmp/kubeflow-test.yaml
      - echo "âœ… Template rendering successful"
      - echo "ğŸ” Checking for bitnami images..."
      - |
        if grep -E "image:.*bitnami|repository:.*bitnami" /tmp/kubeflow-test.yaml; then
          echo "âŒ Found bitnami images in kubeflow chart!"
          exit 1
        else
          echo "âœ… No bitnami images found"
        fi
      - echo "ğŸ“‹ Images used in kubeflow chart:"
      - grep -i "image:" /tmp/kubeflow-test.yaml | grep -v "imagePullPolicy" | sort | uniq
      - rm -f /tmp/kubeflow-test.yaml
    summary: |
      Tests the kubeflow helm chart to ensure:
      - Template renders without errors
      - No bitnami images are used
      - Lists all images used in the chart

  backstage-validate:
    desc: Validate Backstage configuration and check compilation
    dir: ./backstage
    cmds:
      - yarn install
      - yarn tsc

  test-backstage-kro:
    desc: 'Run Kro plugin integration tests'
    dir: ./backstage
    cmds:
      - |
        echo "ğŸ§ª Running Kro Plugin Integration Tests..."
        echo "ğŸ“ Location: backstage/packages/backend/src/plugins/__tests__"
        echo ""

        # Check if yarn is available
        if ! command -v yarn &> /dev/null; then
          echo "âŒ yarn is required but not installed"
          echo "ğŸ’¡ Please install yarn to run Kro plugin tests"
          exit 1
        fi

        # Install dependencies if needed
        echo "ğŸ“¦ Installing dependencies..."
        yarn install

        # Run Kro plugin tests
        echo "ğŸ§ª Running Kro plugin integration tests..."
        yarn test:kro
    summary: |
      Runs comprehensive Kro plugin integration tests:
      - Plugin initialization and configuration tests
      - ResourceGraphDefinition discovery and management tests
      - Catalog integration and entity relationship tests
      - Permission validation and security tests
      - Frontend component integration tests

  test-backstage-kro-frontend:
    desc: 'Run Kro frontend component tests'
    dir: ./backstage
    cmds:
      - |
        echo "ğŸ¨ Running Kro Frontend Component Tests..."
        echo "ğŸ“ Location: backstage/packages/app/src/components/__tests__"
        echo ""

        # Install dependencies if needed
        echo "ğŸ“¦ Installing dependencies..."
        yarn install

        # Run frontend tests specifically
        echo "ğŸ¨ Running Kro frontend component tests..."
        yarn test --testPathPattern="KroIntegration.test.tsx" --verbose --no-coverage --passWithNoTests
    summary: |
      Runs Kro frontend component tests:
      - ResourceGroup table rendering and filtering
      - ResourceGroup details display components
      - Create form validation and submission
      - Catalog API integration and error handling
      - Entity relationship display components

  test-backstage-kro-backend:
    desc: 'Run Kro backend integration tests'
    dir: ./backstage
    cmds:
      - |
        echo "âš™ï¸  Running Kro Backend Integration Tests..."
        echo "ğŸ“ Location: backstage/packages/backend/src/plugins/__tests__"
        echo ""

        # Install dependencies if needed
        echo "ğŸ“¦ Installing dependencies..."
        yarn install

        # Run backend tests specifically
        echo "âš™ï¸  Running Kro backend integration tests..."
        yarn test --testPathPattern="kro.*test\.ts" --verbose --no-coverage --passWithNoTests
    summary: |
      Runs Kro backend integration tests:
      - Plugin initialization and configuration validation
      - ResourceGraphDefinition discovery workflows
      - ResourceGroup creation and management operations
      - Catalog integration and entity processing
      - RBAC validation and permission scenarios
      - Security components and audit logging

  # ===== CICD PIPELINE KRO RGD TESTS =====

  test-kro-unit:
    desc: 'Run unit tests for CI/CD Pipeline Kro RGD'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests
    cmds:
      - |
        echo "ğŸ§ª Running CI/CD Pipeline Kro RGD Unit Tests..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests"
        echo ""

        # Check if npm is available
        if ! command -v npm &> /dev/null; then
          echo "âŒ npm is required but not installed"
          echo "ğŸ’¡ Please install Node.js and npm to run unit tests"
          exit 1
        fi

        # Install dependencies if needed
        if [ ! -d "node_modules" ]; then
          echo "ğŸ“¦ Installing test dependencies..."
          npm install
        fi

        # Run unit tests
        echo "ğŸ”¬ Running unit tests..."
        npm run test
    summary: |
      Runs comprehensive unit tests for the CI/CD Pipeline Kro RGD:
      - Schema validation tests
      - Parameter handling tests  
      - Resource template generation tests
      - Dependency ordering tests

  test-kro-integration:
    desc: 'Run integration tests for CI/CD Pipeline Kro RGD'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests
    cmds:
      - |
        echo "ğŸ”— Running CI/CD Pipeline Kro RGD Integration Tests..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests/integration"
        echo ""

        # Check if npm is available
        if ! command -v npm &> /dev/null; then
          echo "âŒ npm is required but not installed"
          echo "ğŸ’¡ Please install Node.js and npm to run integration tests"
          exit 1
        fi

        # Run integration tests
        echo "ğŸ”— Running integration tests..."
        npm run test:integration
    summary: |
      Runs integration tests for the CI/CD Pipeline Kro RGD:
      - AWS resource validation tests
      - Kubernetes deployment tests
      - End-to-end integration validation

  test-kro-template:
    desc: 'Run Backstage template execution tests'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests/template-execution
    cmds:
      - |
        echo "ğŸ“‹ Running Backstage Template Execution Tests..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests/template-execution"
        echo ""

        # Check if npm is available
        if ! command -v npm &> /dev/null; then
          echo "âŒ npm is required but not installed"
          echo "ğŸ’¡ Please install Node.js and npm to run template tests"
          exit 1
        fi

        # Install dependencies if needed
        if [ ! -d "node_modules" ]; then
          echo "ğŸ“¦ Installing test dependencies..."
          npm install
        fi

        # Run template execution tests
        echo "ğŸ“‹ Running template execution tests..."
        npm run test
    summary: |
      Runs Backstage template execution tests:
      - Template parameter validation
      - YAML manifest generation tests
      - GitLab integration validation
      - ArgoCD application creation tests
      - Pipeline creation validation

  test-kro-deployment:
    desc: 'Run deployment test for CI/CD Pipeline Kro RGD (requires cluster access)'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline
    cmds:
      - |
        echo "ğŸš€ Running CI/CD Pipeline Kro RGD Deployment Test..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline"
        echo "âš ï¸  This test requires active Kubernetes cluster access"
        echo ""

        # Check if kubectl is available
        if ! command -v kubectl &> /dev/null; then
          echo "âŒ kubectl is required but not installed"
          echo "ğŸ’¡ Please install kubectl to run deployment tests"
          exit 1
        fi

        # Check cluster connectivity
        echo "ğŸ” Checking cluster connectivity..."
        kubectl cluster-info --request-timeout=10s || {
          echo "âŒ Cannot connect to Kubernetes cluster"
          echo "ğŸ’¡ Please ensure kubectl is configured and cluster is accessible"
          exit 1
        }

        # Run deployment test
        echo "ğŸš€ Running deployment test..."
        ./tests/test-kro-cicd-instance.sh
    summary: |
      Runs full deployment test for the CI/CD Pipeline Kro RGD:
      - Deploys RGD to active Kubernetes cluster
      - Creates test CICDPipeline instance
      - Validates resource creation and dependencies
      - Verifies resource status and readiness

  test-kro-clean:
    desc: 'Clean up CI/CD Pipeline Kro RGD test resources (requires cluster access)'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline
    cmds:
      - |
        echo "ğŸ§¹ Cleaning up CI/CD Pipeline Kro RGD Test Resources..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline"
        echo "âš ï¸  This will delete test resources from the cluster"
        echo ""

        # Check if kubectl is available
        if ! command -v kubectl &> /dev/null; then
          echo "âŒ kubectl is required but not installed"
          echo "ğŸ’¡ Please install kubectl to run cleanup"
          exit 1
        fi

        # Check cluster connectivity
        echo "ğŸ” Checking cluster connectivity..."
        kubectl cluster-info --request-timeout=10s || {
          echo "âŒ Cannot connect to Kubernetes cluster"
          echo "ğŸ’¡ Please ensure kubectl is configured and cluster is accessible"
          exit 1
        }

        # Run cleanup
        echo "ğŸ§¹ Running cleanup script..."
        ./tests/cleanup-kro-test.sh
    summary: |
      Cleans up test resources created by test-kro-deployment:
      - Deletes test CICDPipeline instance
      - Removes test namespace and all resources
      - Cleans up AWS resources (ECR images, IAM roles/policies)
      - Provides clean slate for next test run

  test-kro-dryrun:
    desc: 'Run dry-run validation for CI/CD Pipeline Kro RGD (no cluster required)'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline
    cmds:
      - |
        echo "ğŸ” Running CI/CD Pipeline Kro RGD Dry-Run Validation..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline"
        echo "âœ… This test does not require cluster access"
        echo ""

        # Run dry-run test
        echo "ğŸ” Running dry-run validation..."
        ./tests/test-kro-cicd-instance-dryrun.sh
    summary: |
      Runs dry-run validation for the CI/CD Pipeline Kro RGD:
      - Validates RGD YAML syntax and structure
      - Tests parameter substitution
      - Validates resource template generation
      - No cluster access required

  test-kro-workflow:
    desc: 'Run workflow integration tests (requires cluster and AWS access)'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests
    cmds:
      - |
        echo "âš™ï¸  Running Workflow Integration Tests..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests"
        echo "âš ï¸  This test requires active Kubernetes cluster and AWS access"
        echo ""

        # Check if npm is available
        if ! command -v npm &> /dev/null; then
          echo "âŒ npm is required but not installed"
          echo "ğŸ’¡ Please install Node.js and npm to run workflow tests"
          exit 1
        fi

        # Run workflow integration tests
        echo "âš™ï¸  Running workflow integration tests..."
        npm run test:workflow
    summary: |
      Runs workflow integration tests for the CI/CD Pipeline Kro RGD:
      - Tests Argo Workflows integration
      - Validates ECR credential management
      - Tests GitLab webhook integration
      - Requires active cluster and AWS credentials

  test-kro-all:
    desc: 'Run all CI/CD Pipeline Kro RGD tests'
    deps: [test-kro-unit, test-kro-template, test-kro-dryrun]
    cmds:
      - |
        echo ""
        echo "ğŸ‰ All CI/CD Pipeline Kro RGD tests completed!"
        echo ""
        echo "ğŸ“‹ Summary of tests executed:"
        echo "  âœ… Unit tests (schema, parameters, templates)"
        echo "  âœ… Template execution tests (Backstage integration)"
        echo "  âœ… Dry-run validation (syntax and structure)"
        echo ""
        echo "ğŸ’¡ Additional tests available:"
        echo "  - task test-kro-integration (requires npm and cluster access)"
        echo "  - task test-kro-deployment (requires cluster access)"
        echo "  - task test-kro-workflow (requires cluster and AWS access)"
    summary: |
      Runs comprehensive test suite for CI/CD Pipeline Kro RGD:
      - Executes unit tests, template tests, and dry-run validation
      - Provides complete validation without requiring cluster access
      - Additional integration tests available separately

  test-kro-complete:
    desc: 'Run all Kro tests (RGD + Backstage plugin integration)'
    deps: [test-kro-all, test-backstage-kro]
    cmds:
      - |
        echo ""
        echo "ğŸ‰ Complete Kro Test Suite Finished!"
        echo ""
        echo "ğŸ“‹ Summary of all tests executed:"
        echo ""
        echo "ğŸ”§ KRO RGD TESTS:"
        echo "  âœ… Unit tests (schema, parameters, templates)"
        echo "  âœ… Template execution tests (Backstage integration)"
        echo "  âœ… Dry-run validation (syntax and structure)"
        echo ""
        echo "ğŸ—ï¸  BACKSTAGE PLUGIN TESTS:"
        echo "  âœ… Plugin initialization and configuration"
        echo "  âœ… ResourceGraphDefinition discovery and management"
        echo "  âœ… Catalog integration and entity relationships"
        echo "  âœ… Permission validation and security"
        echo "  âœ… Frontend component integration"
        echo ""
        echo "ğŸ’¡ Additional integration tests available:"
        echo "  - task test-kro-integration (requires cluster access)"
        echo "  - task test-kro-deployment (requires cluster access)"
        echo "  - task test-kro-workflow (requires cluster and AWS access)"
    summary: |
      Runs the complete Kro test suite including:
      - All CI/CD Pipeline Kro RGD tests (unit, template, dry-run)
      - All Backstage plugin integration tests (frontend + backend)
      - Comprehensive validation of the entire Kro ecosystem

  default:
    desc: 'Show available tasks'
    cmds:
      - |
        echo "ğŸ“‹ Available tasks:"
        echo ""
        echo "ğŸ”§ HELM CHART MANAGEMENT:"
        echo "  task build-helm-dependencies    - Build Helm chart dependencies"
        echo "  task check-helm-dependencies    - Check which charts have dependencies"
        echo "  task clean-helm-dependencies    - Clean generated dependency files"
        echo "  task test-applicationsets       - Test ApplicationSet generation"
        echo ""
        echo "ğŸ—ï¸  BACKSTAGE:"
        echo "  task backstage-validate         - Validate Backstage configuration"
        echo "  task test-backstage-kro         - Run Kro plugin integration tests"
        echo "  task test-backstage-kro-frontend - Run Kro frontend component tests"
        echo "  task test-backstage-kro-backend - Run Kro backend integration tests"
        echo ""
        echo "ğŸ§ª CI/CD PIPELINE KRO RGD TESTS:"
        echo "  task test-kro-unit              - Run unit tests (schema, parameters, templates)"
        echo "  task test-kro-template          - Run Backstage template execution tests"
        echo "  task test-kro-dryrun            - Run dry-run validation (no cluster required)"
        echo "  task test-kro-integration       - Run integration tests (requires cluster)"
        echo "  task test-kro-deployment        - Run deployment test (requires cluster)"
        echo "  task test-kro-workflow          - Run workflow integration tests (requires cluster + AWS)"
        echo "  task test-kro-all               - Run all basic RGD tests (unit, template, dry-run)"
        echo ""
        echo "ğŸ”— COMPLETE KRO TEST SUITE:"
        echo "  task test-kro-complete          - Run ALL Kro tests (RGD + Backstage plugin)"
