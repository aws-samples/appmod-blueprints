version: '3'

tasks:
  build-helm-dependencies:
    desc: Build Helm chart dependencies for all addon charts that require them
    cmds:
      - echo "Adding required Helm repositories..."
      - helm repo add crossplane-stable https://charts.crossplane.io/stable || true
      - helm repo add kubevela https://kubevela.github.io/charts || true
      - helm repo add fluxcd-community https://fluxcd-community.github.io/helm-charts || true
      - helm repo update
      - echo "Building dependencies for flux chart..."
      - cd ./gitops/addons/charts/flux && helm dependency build
      - echo "Building dependencies for crossplane chart..."
      - cd ./gitops/addons/charts/crossplane && helm dependency build
      - echo "Building dependencies for kubevela chart..."
      - cd ./gitops/addons/charts/kubevela && helm dependency build
      - echo "All Helm chart dependencies built successfully!"
      - echo "Don't forget to commit the generated Chart.lock files and charts/ directories"

  check-helm-dependencies:
    desc: Check which charts have dependencies defined
    cmds:
      - echo "Charts with dependencies:"
      - find ./gitops/addons/charts -name "Chart.yaml" -exec grep -l "dependencies:" {} \;
      - echo ""
      - echo "Checking for missing Chart.lock files:"
      - |
        for chart in $(find ./gitops/addons/charts -name "Chart.yaml" -exec grep -l "dependencies:" {} \;); do
          chart_dir=$(dirname "$chart")
          if [ ! -f "$chart_dir/Chart.lock" ]; then
            echo "Missing Chart.lock: $chart_dir"
          else
            echo "Found Chart.lock: $chart_dir"
          fi
        done

  clean-helm-dependencies:
    desc: Clean all generated Helm dependency files
    cmds:
      - echo "Cleaning Chart.lock files and charts/ directories..."
      - find ./gitops/addons/charts -name "Chart.lock" -delete
      - find ./gitops/addons/charts -name "charts" -type d -exec rm -rf {} + 2>/dev/null || true
      - echo "Cleaned all Helm dependency files"

  test-applicationsets:
    desc: Test ApplicationSet generation locally using helm template
    cmds:
      - |
        cd ./gitops/addons/charts/application-sets && \
        helm template test-appsets . \
          -f ../../bootstrap/default/addons.yaml \
          -f ../../environments/control-plane/addons.yaml \
          --set repoURLGit="https://github.com/aws-samples/appmod-blueprints" \
          --set repoURLGitRevision="main" \
          --set repoURLGitBasePath="gitops/addons/"
        #grep -A 50 -B 5 "name: crossplane-aws"

  backstage-validate:
    desc: Validate Backstage configuration and check compilation
    dir: ./backstage
    cmds:
      - yarn install
      - yarn tsc

  # ===== CICD PIPELINE KRO RGD TESTS =====

  test-kro-unit:
    desc: 'Run unit tests for CI/CD Pipeline Kro RGD'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests
    cmds:
      - |
        echo "ğŸ§ª Running CI/CD Pipeline Kro RGD Unit Tests..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests"
        echo ""

        # Check if npm is available
        if ! command -v npm &> /dev/null; then
          echo "âŒ npm is required but not installed"
          echo "ğŸ’¡ Please install Node.js and npm to run unit tests"
          exit 1
        fi

        # Install dependencies if needed
        if [ ! -d "node_modules" ]; then
          echo "ğŸ“¦ Installing test dependencies..."
          npm install
        fi

        # Run unit tests
        echo "ğŸ”¬ Running unit tests..."
        npm run test
    summary: |
      Runs comprehensive unit tests for the CI/CD Pipeline Kro RGD:
      - Schema validation tests
      - Parameter handling tests  
      - Resource template generation tests
      - Dependency ordering tests

  test-kro-integration:
    desc: 'Run integration tests for CI/CD Pipeline Kro RGD'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests
    cmds:
      - |
        echo "ğŸ”— Running CI/CD Pipeline Kro RGD Integration Tests..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests/integration"
        echo ""

        # Check if npm is available
        if ! command -v npm &> /dev/null; then
          echo "âŒ npm is required but not installed"
          echo "ğŸ’¡ Please install Node.js and npm to run integration tests"
          exit 1
        fi

        # Run integration tests
        echo "ğŸ”— Running integration tests..."
        npm run test:integration
    summary: |
      Runs integration tests for the CI/CD Pipeline Kro RGD:
      - AWS resource validation tests
      - Kubernetes deployment tests
      - End-to-end integration validation

  test-kro-template:
    desc: 'Run Backstage template execution tests'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests/template-execution
    cmds:
      - |
        echo "ğŸ“‹ Running Backstage Template Execution Tests..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests/template-execution"
        echo ""

        # Check if npm is available
        if ! command -v npm &> /dev/null; then
          echo "âŒ npm is required but not installed"
          echo "ğŸ’¡ Please install Node.js and npm to run template tests"
          exit 1
        fi

        # Install dependencies if needed
        if [ ! -d "node_modules" ]; then
          echo "ğŸ“¦ Installing test dependencies..."
          npm install
        fi

        # Run template execution tests
        echo "ğŸ“‹ Running template execution tests..."
        npm run test
    summary: |
      Runs Backstage template execution tests:
      - Template parameter validation
      - YAML manifest generation tests
      - GitLab integration validation
      - ArgoCD application creation tests
      - Pipeline creation validation

  test-kro-deployment:
    desc: 'Run deployment test for CI/CD Pipeline Kro RGD (requires cluster access)'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline
    cmds:
      - |
        echo "ğŸš€ Running CI/CD Pipeline Kro RGD Deployment Test..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline"
        echo "âš ï¸  This test requires active Kubernetes cluster access"
        echo ""

        # Check if kubectl is available
        if ! command -v kubectl &> /dev/null; then
          echo "âŒ kubectl is required but not installed"
          echo "ğŸ’¡ Please install kubectl to run deployment tests"
          exit 1
        fi

        # Check cluster connectivity
        echo "ğŸ” Checking cluster connectivity..."
        kubectl cluster-info --request-timeout=10s || {
          echo "âŒ Cannot connect to Kubernetes cluster"
          echo "ğŸ’¡ Please ensure kubectl is configured and cluster is accessible"
          exit 1
        }

        # Run deployment test
        echo "ğŸš€ Running deployment test..."
        ./tests/test-kro-cicd-instance.sh
    summary: |
      Runs full deployment test for the CI/CD Pipeline Kro RGD:
      - Deploys RGD to active Kubernetes cluster
      - Creates test CICDPipeline instance
      - Validates resource creation and dependencies
      - Verifies resource status and readiness

  test-kro-clean:
    desc: 'Clean up CI/CD Pipeline Kro RGD test resources (requires cluster access)'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline
    cmds:
      - |
        echo "ğŸ§¹ Cleaning up CI/CD Pipeline Kro RGD Test Resources..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline"
        echo "âš ï¸  This will delete test resources from the cluster"
        echo ""

        # Check if kubectl is available
        if ! command -v kubectl &> /dev/null; then
          echo "âŒ kubectl is required but not installed"
          echo "ğŸ’¡ Please install kubectl to run cleanup"
          exit 1
        fi

        # Check cluster connectivity
        echo "ğŸ” Checking cluster connectivity..."
        kubectl cluster-info --request-timeout=10s || {
          echo "âŒ Cannot connect to Kubernetes cluster"
          echo "ğŸ’¡ Please ensure kubectl is configured and cluster is accessible"
          exit 1
        }

        # Run cleanup
        echo "ğŸ§¹ Running cleanup script..."
        ./tests/cleanup-kro-test.sh
    summary: |
      Cleans up test resources created by test-kro-deployment:
      - Deletes test CICDPipeline instance
      - Removes test namespace and all resources
      - Cleans up AWS resources (ECR images, IAM roles/policies)
      - Provides clean slate for next test run

  test-kro-dryrun:
    desc: 'Run dry-run validation for CI/CD Pipeline Kro RGD (no cluster required)'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline
    cmds:
      - |
        echo "ğŸ” Running CI/CD Pipeline Kro RGD Dry-Run Validation..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline"
        echo "âœ… This test does not require cluster access"
        echo ""

        # Run dry-run test
        echo "ğŸ” Running dry-run validation..."
        ./tests/test-kro-cicd-instance-dryrun.sh
    summary: |
      Runs dry-run validation for the CI/CD Pipeline Kro RGD:
      - Validates RGD YAML syntax and structure
      - Tests parameter substitution
      - Validates resource template generation
      - No cluster access required

  test-kro-workflow:
    desc: 'Run workflow integration tests (requires cluster and AWS access)'
    dir: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests
    cmds:
      - |
        echo "âš™ï¸  Running Workflow Integration Tests..."
        echo "ğŸ“ Location: gitops/addons/charts/kro/resource-groups/cicd-pipeline/tests"
        echo "âš ï¸  This test requires active Kubernetes cluster and AWS access"
        echo ""

        # Check if npm is available
        if ! command -v npm &> /dev/null; then
          echo "âŒ npm is required but not installed"
          echo "ğŸ’¡ Please install Node.js and npm to run workflow tests"
          exit 1
        fi

        # Run workflow integration tests
        echo "âš™ï¸  Running workflow integration tests..."
        npm run test:workflow
    summary: |
      Runs workflow integration tests for the CI/CD Pipeline Kro RGD:
      - Tests Argo Workflows integration
      - Validates ECR credential management
      - Tests GitLab webhook integration
      - Requires active cluster and AWS credentials

  test-kro-all:
    desc: 'Run all CI/CD Pipeline Kro RGD tests'
    deps: [test-kro-unit, test-kro-template, test-kro-dryrun]
    cmds:
      - |
        echo ""
        echo "ğŸ‰ All CI/CD Pipeline Kro RGD tests completed!"
        echo ""
        echo "ğŸ“‹ Summary of tests executed:"
        echo "  âœ… Unit tests (schema, parameters, templates)"
        echo "  âœ… Template execution tests (Backstage integration)"
        echo "  âœ… Dry-run validation (syntax and structure)"
        echo ""
        echo "ğŸ’¡ Additional tests available:"
        echo "  - task test-kro-integration (requires npm and cluster access)"
        echo "  - task test-kro-deployment (requires cluster access)"
        echo "  - task test-kro-workflow (requires cluster and AWS access)"
    summary: |
      Runs comprehensive test suite for CI/CD Pipeline Kro RGD:
      - Executes unit tests, template tests, and dry-run validation
      - Provides complete validation without requiring cluster access
      - Additional integration tests available separately

  default:
    desc: 'Show available tasks'
    cmds:
      - |
        echo "ğŸ“‹ Available tasks:"
        echo ""
        echo "ğŸ”§ HELM CHART MANAGEMENT:"
        echo "  task build-helm-dependencies    - Build Helm chart dependencies"
        echo "  task check-helm-dependencies    - Check which charts have dependencies"
        echo "  task clean-helm-dependencies    - Clean generated dependency files"
        echo "  task test-applicationsets       - Test ApplicationSet generation"
        echo ""
        echo "ğŸ—ï¸  BACKSTAGE:"
        echo "  task backstage-validate         - Validate Backstage configuration"
        echo ""
        echo "ğŸ§ª CI/CD PIPELINE KRO RGD TESTS:"
        echo "  task test-kro-unit              - Run unit tests (schema, parameters, templates)"
        echo "  task test-kro-template          - Run Backstage template execution tests"
        echo "  task test-kro-dryrun            - Run dry-run validation (no cluster required)"
        echo "  task test-kro-integration       - Run integration tests (requires cluster)"
        echo "  task test-kro-deployment        - Run deployment test (requires cluster)"
        echo "  task test-kro-workflow          - Run workflow integration tests (requires cluster + AWS)"
        echo "  task test-kro-all               - Run all basic tests (unit, template, dry-run)"
